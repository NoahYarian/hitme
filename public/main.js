"use strict";

var API = "http://deckofcardsapi.com/api/";
var newDeckURL = API + "shuffle/?deck_count=6";
var cardBack = "http://tinyurl.com/kqzzmbr";

var game;
var deckId = "";
var score = 0;
var count = 0;

//buttons
var $newGame = $(".newGame");
var $hit = $(".hit");
var $stay = $(".stay");

//scoreboard divs
var $score = $(".score");
var $count = $(".count");
var $announce = $(".announce");
var $announceText = $(".announce p");

//card hand divs
var $dealer = $(".dealer");
var $player = $(".player");

//create audio elements
var cardPlace = document.createElement("audio");
cardPlace.setAttribute("src", "sounds/cardPlace1.wav");

var cardPackage = document.createElement("audio");
cardPackage.setAttribute("src", "sounds/cardOpenPackage2.wav");

var buttonClick = document.createElement("audio");
buttonClick.setAttribute("src", "sounds/click1.wav");

var winWav = document.createElement("audio");
winWav.setAttribute("src", "sounds/chipsHandle5.wav");

var loseWav = document.createElement("audio");
loseWav.setAttribute("src", "sounds/cardShove3.wav");

//button click listeners
$("button").on("click", function () {
  buttonClick.load();
  buttonClick.play();
});
$newGame.on("click", newGame);
$hit.on("click", hit);
$stay.on("click", function () {
  console.log("stay");
  stay();
});

//game object
function Game() {
  this.hiddenCard = "";
  this.dealerHand = [];
  this.playerHand = [];
  this.dealerTotal = 0;
  this.playerTotal = 0;
  this.winner = "";
}

function newGame() {
  game = new Game();
  deal();
}

function deal() {
  clearTable();
  $newGame.attr("disabled", true);
  $hit.attr("disabled", false);
  $stay.attr("disabled", false);
  cardPackage.load();
  cardPackage.play();
  if (deckId === "") {
    getJSON(newDeckURL, function (data) {
      deckId = data.deck_id;
      console.log("About to deal from new deck");
      draw4();
    });
  } else {
    console.log("About to deal from current deck");
    draw4();
  }
}

function draw4() {
  drawCard({
    person: "dealer",
    image: cardBack
  });
  drawCard({
    person: "player"
  });
  drawCard({
    person: "dealer"
  });
  drawCard({
    person: "player"
  });
}

function drawCard(options) {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data, cb) {
    var html;
    cardPlace.load();
    cardPlace.play();
    options.image ? (html = "<img class='cardImage' src='" + options.image + "'>", $("." + options.person).append(html), game.hiddenCard = cardImage(data)) : (html = "<img class='cardImage' src='" + cardImage(data) + "'>", $("." + options.person).append(html));
    options.person === "dealer" ? (game.dealerHand.push(data.cards[0].value), checkTotal("dealer"), console.log("dealer's hand - " + game.dealerHand + " **** dealer is at " + game.dealerTotal)) : (game.playerHand.push(data.cards[0].value), checkTotal("player"), console.log("player's hand - " + game.playerHand + " **** player is at " + game.playerTotal));
    checkVictory();
    updateCount(data.cards[0].value);
    typeof options.callback === "function" && options.callback();
  });
}

function hit() {
  console.log("hit");
  drawCard({
    person: "player"
  });
}

function stay() {
  flipCard();
  if (game.winner === "" && game.dealerTotal < 17) {
    console.log("dealer hits");
    drawCard({
      person: "dealer",
      callback: stay
    });
  } else if (game.dealerTotal === game.playerTotal) {
    game.winner = "push";
    announce("PUSH");
    console.log("push");
  } else if (game.dealerTotal < 22) {
    game.dealerTotal > game.playerTotal ? (game.winner = "dealer", announce("YOU LOSE"), score -= 1, console.log("dealer's " + game.dealerTotal + " beats player's " + game.playerTotal)) : (game.winner = "player", announce("YOU WIN"), score += 1, console.log("player's " + game.playerTotal + " beats dealer's " + game.dealerTotal));
  }
  gameEnd();
}

function checkTotal(person) {
  var total = 0;
  var hand = person === "dealer" ? game.dealerHand : game.playerHand;
  var aces = 0;

  hand.forEach(function (card) {
    if (card === "KING" || card === "QUEEN" || card === "JACK") {
      total += 10;
    } else if (!isNaN(card)) {
      total += Number(card);
    } else if (card === "ACE") {
      aces += 1;
    }
    // if (card === "ACE") {
    //   if (total <= 10) {
    //     total += 11;
    //   } else {
    //     total += 1;
    //   }
    // }
  });

  //Inelegant solution to the "AAJ" problem. If the aces are drawn first
  //they will cause the player to bust without this extra logic. This does not account
  //for all possibilities but the chances of being dealt something like "AAAAAA5"
  //are astronomically low.
  switch (aces) {
    case 1:
      if (total <= 10) {
        total += 11;
      } else {
        total += 1;
      }
      break;
    case 2:
      if (total <= 9) {
        total += 12;
      } else {
        total += 2;
      }
      break;
    case 3:
      if (total <= 8) {
        total += 13;
      } else {
        total += 3;
      }
      break;
    case 4:
      if (total <= 7) {
        total += 14;
      } else {
        total += 4;
      }
      break;
    case 5:
      if (total <= 6) {
        total += 15;
      } else {
        total += 5;
      }
      break;
  }

  person === "dealer" ? game.dealerTotal = total : game.playerTotal = total;
}

function checkVictory() {
  if (game.dealerTotal === 21) {
    console.log("dealer has 21");
    game.winner = "dealer";
    score -= 1;
    announce("YOU LOSE");
  } else if (game.dealerTotal > 21) {
    console.log("dealer busts");
    game.winner = "player";
    score += 1;
    announce("YOU WIN");
  }

  if (game.playerTotal === 21) {
    console.log("player has 21");
    game.winner = "player";
    score += 1;
    announce("21!");
  } else if (game.playerTotal > 21) {
    console.log("player busts");
    game.winner = "dealer";
    score -= 1;
    announce("BUST");
  }

  if (game.winner !== "") {
    flipCard();
    gameEnd();
  }
}

function gameEnd() {
  updateScore();
  $newGame.attr("disabled", false);
  $hit.attr("disabled", true);
  $stay.attr("disabled", true);
}

function clearTable() {
  $dealer.empty();
  $player.empty();
  $announce.removeClass("win lose push");
  console.log("--table cleared--");
}

function cardImage(data) {
  var cardValue = data.cards[0].value;
  var cardSuit = data.cards[0].suit;
  var filename = "../images/cards/" + cardValue + "_of_" + cardSuit.toLowerCase() + ".svg";
  return filename;
}

function announce(text) {
  if (game.winner === "dealer") {
    $announce.addClass("lose");
    loseWav.load();
    loseWav.play();
  } else if (game.winner === "player") {
    $announce.addClass("win");
    winWav.load();
    winWav.play();
  } else if (game.winner === "push") {
    $announce.addClass("push");
  }
  $announceText.text(text);
}

function flipCard() {
  var $flipped = $(".dealer .cardImage");
  $flipped.first().attr("src", game.hiddenCard);
}

function updateScore() {
  $score.empty();
  $score.append("<p>Score: " + score + "</p>");
}

function updateCount(card) {
  if (isNaN(Number(card)) || card === "10") {
    count -= 1;
  } else if (card < 7) {
    count += 1;
  }
  $count.empty();
  $count.append("<p>Count: " + count + "</p>");
}

// JSON request function with JSONP proxy
function getJSON(url, cb) {
  var JSONP_PROXY = "https://jsonp.afeld.me/?url=";
  // THIS WILL ADD THE CROSS ORIGIN HEADERS
  var request = new XMLHttpRequest();
  request.open("GET", JSONP_PROXY + url);
  request.onload = function () {
    if (request.status >= 200 && request.status < 400) {
      cb(JSON.parse(request.responseText));
    } else {
      cb(JSON.parse(request.responseText));
    }
  };
  request.send();
}
//# sourceMappingURL=data:application/json;base64,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TyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7S0FDdEM7R0FDRixDQUFDO0FBQ0YsU0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO0NBQ2hCIiwiZmlsZSI6InNyYy9tYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEFQSSA9IFwiaHR0cDovL2RlY2tvZmNhcmRzYXBpLmNvbS9hcGkvXCI7XG52YXIgbmV3RGVja1VSTCA9IEFQSSArIFwic2h1ZmZsZS8/ZGVja19jb3VudD02XCI7XG52YXIgY2FyZEJhY2sgPSBcImh0dHA6Ly90aW55dXJsLmNvbS9rcXp6bWJyXCI7XG5cbnZhciBnYW1lO1xudmFyIGRlY2tJZCA9IFwiXCI7XG52YXIgc2NvcmUgPSAwO1xudmFyIGNvdW50ID0gMDtcblxuLy9idXR0b25zXG52YXIgJG5ld0dhbWUgPSAkKFwiLm5ld0dhbWVcIik7XG52YXIgJGhpdCA9ICQoXCIuaGl0XCIpO1xudmFyICRzdGF5ID0gJChcIi5zdGF5XCIpO1xuXG4vL3Njb3JlYm9hcmQgZGl2c1xudmFyICRzY29yZSA9ICQoXCIuc2NvcmVcIik7XG52YXIgJGNvdW50ID0gJChcIi5jb3VudFwiKTtcbnZhciAkYW5ub3VuY2UgPSAkKFwiLmFubm91bmNlXCIpXG52YXIgJGFubm91bmNlVGV4dCA9ICQoXCIuYW5ub3VuY2UgcFwiKVxuXG4vL2NhcmQgaGFuZCBkaXZzXG52YXIgJGRlYWxlciA9ICQoXCIuZGVhbGVyXCIpO1xudmFyICRwbGF5ZXIgPSAkKFwiLnBsYXllclwiKTtcblxuLy9jcmVhdGUgYXVkaW8gZWxlbWVudHNcbnZhciBjYXJkUGxhY2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhdWRpbycpO1xuY2FyZFBsYWNlLnNldEF0dHJpYnV0ZSgnc3JjJywgJ3NvdW5kcy9jYXJkUGxhY2UxLndhdicpO1xuXG52YXIgY2FyZFBhY2thZ2UgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhdWRpbycpO1xuY2FyZFBhY2thZ2Uuc2V0QXR0cmlidXRlKCdzcmMnLCAnc291bmRzL2NhcmRPcGVuUGFja2FnZTIud2F2Jyk7XG5cbnZhciBidXR0b25DbGljayA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F1ZGlvJyk7XG5idXR0b25DbGljay5zZXRBdHRyaWJ1dGUoJ3NyYycsICdzb3VuZHMvY2xpY2sxLndhdicpO1xuXG52YXIgd2luV2F2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYXVkaW8nKTtcbndpbldhdi5zZXRBdHRyaWJ1dGUoJ3NyYycsICdzb3VuZHMvY2hpcHNIYW5kbGU1LndhdicpO1xuXG52YXIgbG9zZVdhdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F1ZGlvJyk7XG5sb3NlV2F2LnNldEF0dHJpYnV0ZSgnc3JjJywgJ3NvdW5kcy9jYXJkU2hvdmUzLndhdicpO1xuXG4vL2J1dHRvbiBjbGljayBsaXN0ZW5lcnNcbiQoXCJidXR0b25cIikub24oXCJjbGlja1wiLCBmdW5jdGlvbiAoKSB7XG4gIGJ1dHRvbkNsaWNrLmxvYWQoKTtcbiAgYnV0dG9uQ2xpY2sucGxheSgpO1xufSk7XG4kbmV3R2FtZS5vbihcImNsaWNrXCIsIG5ld0dhbWUpO1xuJGhpdC5vbihcImNsaWNrXCIsIGhpdCk7XG4kc3RheS5vbihcImNsaWNrXCIsIGZ1bmN0aW9uICgpIHtcbiAgY29uc29sZS5sb2coXCJzdGF5XCIpO1xuICBzdGF5KCk7XG59KTtcblxuLy9nYW1lIG9iamVjdFxuZnVuY3Rpb24gR2FtZSgpIHtcbiAgdGhpcy5oaWRkZW5DYXJkID0gXCJcIjtcbiAgdGhpcy5kZWFsZXJIYW5kID0gW107XG4gIHRoaXMucGxheWVySGFuZCA9IFtdO1xuICB0aGlzLmRlYWxlclRvdGFsID0gMDtcbiAgdGhpcy5wbGF5ZXJUb3RhbCA9IDA7XG4gIHRoaXMud2lubmVyID0gXCJcIjtcbn1cblxuZnVuY3Rpb24gbmV3R2FtZSgpIHtcbiAgZ2FtZSA9IG5ldyBHYW1lKCk7XG4gIGRlYWwoKTtcbn1cblxuZnVuY3Rpb24gZGVhbCgpIHtcbiAgY2xlYXJUYWJsZSgpO1xuICAkbmV3R2FtZS5hdHRyKFwiZGlzYWJsZWRcIiwgdHJ1ZSk7XG4gICRoaXQuYXR0cihcImRpc2FibGVkXCIsIGZhbHNlKTtcbiAgJHN0YXkuYXR0cihcImRpc2FibGVkXCIsIGZhbHNlKTtcbiAgY2FyZFBhY2thZ2UubG9hZCgpO1xuICBjYXJkUGFja2FnZS5wbGF5KCk7XG4gIGlmIChkZWNrSWQgPT09IFwiXCIpIHtcbiAgICBnZXRKU09OKG5ld0RlY2tVUkwsIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgIGRlY2tJZCA9IGRhdGEuZGVja19pZDtcbiAgICAgIGNvbnNvbGUubG9nKFwiQWJvdXQgdG8gZGVhbCBmcm9tIG5ldyBkZWNrXCIpO1xuICAgICAgZHJhdzQoKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhcIkFib3V0IHRvIGRlYWwgZnJvbSBjdXJyZW50IGRlY2tcIik7XG4gICAgZHJhdzQoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBkcmF3NCgpIHtcbiAgZHJhd0NhcmQoe1xuICAgIHBlcnNvbjogXCJkZWFsZXJcIixcbiAgICBpbWFnZTogY2FyZEJhY2tcbiAgfSk7XG4gIGRyYXdDYXJkKHtcbiAgICBwZXJzb246IFwicGxheWVyXCJcbiAgfSk7XG4gIGRyYXdDYXJkKHtcbiAgICBwZXJzb246IFwiZGVhbGVyXCJcbiAgfSk7XG4gIGRyYXdDYXJkKHtcbiAgICBwZXJzb246IFwicGxheWVyXCJcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGRyYXdDYXJkKG9wdGlvbnMpIHtcbiAgdmFyIGNhcmRVUkwgPSBBUEkgKyBcImRyYXcvXCIgKyBkZWNrSWQgKyBcIi8/Y291bnQ9MVwiO1xuICBnZXRKU09OKGNhcmRVUkwsIGZ1bmN0aW9uKGRhdGEsIGNiKSB7XG4gICAgdmFyIGh0bWw7XG4gICAgY2FyZFBsYWNlLmxvYWQoKTtcbiAgICBjYXJkUGxhY2UucGxheSgpO1xuICAgIG9wdGlvbnMuaW1hZ2UgPyAoXG4gICAgICBodG1sID0gXCI8aW1nIGNsYXNzPSdjYXJkSW1hZ2UnIHNyYz0nXCIgKyBvcHRpb25zLmltYWdlICsgXCInPlwiLFxuICAgICAgJChcIi5cIiArIG9wdGlvbnMucGVyc29uKS5hcHBlbmQoaHRtbCksXG4gICAgICBnYW1lLmhpZGRlbkNhcmQgPSBjYXJkSW1hZ2UoZGF0YSlcbiAgICApIDogKFxuICAgICAgaHRtbCA9IFwiPGltZyBjbGFzcz0nY2FyZEltYWdlJyBzcmM9J1wiICsgY2FyZEltYWdlKGRhdGEpICsgXCInPlwiLFxuICAgICAgJChcIi5cIiArIG9wdGlvbnMucGVyc29uKS5hcHBlbmQoaHRtbClcbiAgICApO1xuICAgIG9wdGlvbnMucGVyc29uID09PSBcImRlYWxlclwiID8gKFxuICAgICAgZ2FtZS5kZWFsZXJIYW5kLnB1c2goZGF0YS5jYXJkc1swXS52YWx1ZSksXG4gICAgICBjaGVja1RvdGFsKFwiZGVhbGVyXCIpLFxuICAgICAgY29uc29sZS5sb2coXCJkZWFsZXIncyBoYW5kIC0gXCIgKyBnYW1lLmRlYWxlckhhbmQgKyBcIiAqKioqIGRlYWxlciBpcyBhdCBcIiArIGdhbWUuZGVhbGVyVG90YWwpXG4gICAgKSA6IChcbiAgICAgIGdhbWUucGxheWVySGFuZC5wdXNoKGRhdGEuY2FyZHNbMF0udmFsdWUpLFxuICAgICAgY2hlY2tUb3RhbChcInBsYXllclwiKSxcbiAgICAgIGNvbnNvbGUubG9nKFwicGxheWVyJ3MgaGFuZCAtIFwiICsgZ2FtZS5wbGF5ZXJIYW5kICsgXCIgKioqKiBwbGF5ZXIgaXMgYXQgXCIgKyBnYW1lLnBsYXllclRvdGFsKVxuICAgICk7XG4gICAgY2hlY2tWaWN0b3J5KCk7XG4gICAgdXBkYXRlQ291bnQoZGF0YS5jYXJkc1swXS52YWx1ZSk7XG4gICAgdHlwZW9mIG9wdGlvbnMuY2FsbGJhY2sgPT09ICdmdW5jdGlvbicgJiYgb3B0aW9ucy5jYWxsYmFjaygpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gaGl0KCkge1xuICBjb25zb2xlLmxvZyhcImhpdFwiKTtcbiAgZHJhd0NhcmQoe1xuICAgIHBlcnNvbjogXCJwbGF5ZXJcIlxuICB9KTtcbn1cblxuZnVuY3Rpb24gc3RheSgpIHtcbiAgZmxpcENhcmQoKTtcbiAgaWYgKGdhbWUud2lubmVyID09PSBcIlwiICYmIGdhbWUuZGVhbGVyVG90YWwgPCAxNykge1xuICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyIGhpdHNcIik7XG4gICAgZHJhd0NhcmQoe1xuICAgICAgcGVyc29uOiBcImRlYWxlclwiLFxuICAgICAgY2FsbGJhY2s6IHN0YXlcbiAgICB9KTtcbiAgfSBlbHNlIGlmIChnYW1lLmRlYWxlclRvdGFsID09PSBnYW1lLnBsYXllclRvdGFsKSB7XG4gICAgZ2FtZS53aW5uZXIgPSBcInB1c2hcIjtcbiAgICBhbm5vdW5jZShcIlBVU0hcIik7XG4gICAgY29uc29sZS5sb2coXCJwdXNoXCIpO1xuICB9IGVsc2UgaWYgKGdhbWUuZGVhbGVyVG90YWwgPCAyMikge1xuICAgIGdhbWUuZGVhbGVyVG90YWwgPiBnYW1lLnBsYXllclRvdGFsID8gKFxuICAgICAgZ2FtZS53aW5uZXIgPSBcImRlYWxlclwiLFxuICAgICAgYW5ub3VuY2UoXCJZT1UgTE9TRVwiKSxcbiAgICAgIHNjb3JlIC09IDEsXG4gICAgICBjb25zb2xlLmxvZyhcImRlYWxlcidzIFwiICsgZ2FtZS5kZWFsZXJUb3RhbCArIFwiIGJlYXRzIHBsYXllcidzIFwiICsgZ2FtZS5wbGF5ZXJUb3RhbClcbiAgICApIDogKFxuICAgICAgZ2FtZS53aW5uZXIgPSBcInBsYXllclwiLFxuICAgICAgYW5ub3VuY2UoXCJZT1UgV0lOXCIpLFxuICAgICAgc2NvcmUgKz0gMSxcbiAgICAgIGNvbnNvbGUubG9nKFwicGxheWVyJ3MgXCIgKyBnYW1lLnBsYXllclRvdGFsICsgXCIgYmVhdHMgZGVhbGVyJ3MgXCIgKyBnYW1lLmRlYWxlclRvdGFsKVxuICAgICk7XG4gIH1cbiAgZ2FtZUVuZCgpO1xufVxuXG5mdW5jdGlvbiBjaGVja1RvdGFsKHBlcnNvbikge1xuICB2YXIgdG90YWwgPSAwO1xuICB2YXIgaGFuZCA9IHBlcnNvbiA9PT0gXCJkZWFsZXJcIiA/IGdhbWUuZGVhbGVySGFuZCA6IGdhbWUucGxheWVySGFuZDtcbiAgdmFyIGFjZXMgPSAwO1xuXG4gIGhhbmQuZm9yRWFjaChmdW5jdGlvbihjYXJkKSB7XG4gICAgaWYgKGNhcmQgPT09IFwiS0lOR1wiIHx8IGNhcmQgPT09IFwiUVVFRU5cIiB8fCBjYXJkID09PSBcIkpBQ0tcIikge1xuICAgICAgdG90YWwgKz0gMTA7XG4gICAgfSBlbHNlIGlmICghaXNOYU4oY2FyZCkpIHtcbiAgICAgIHRvdGFsICs9IE51bWJlcihjYXJkKTtcbiAgICB9IGVsc2UgaWYgKGNhcmQgPT09IFwiQUNFXCIpIHtcbiAgICAgIGFjZXMgKz0gMTtcbiAgICB9XG4gICAgLy8gaWYgKGNhcmQgPT09IFwiQUNFXCIpIHtcbiAgICAvLyAgIGlmICh0b3RhbCA8PSAxMCkge1xuICAgIC8vICAgICB0b3RhbCArPSAxMTtcbiAgICAvLyAgIH0gZWxzZSB7XG4gICAgLy8gICAgIHRvdGFsICs9IDE7XG4gICAgLy8gICB9XG4gICAgLy8gfVxuICB9KTtcblxuLy9JbmVsZWdhbnQgc29sdXRpb24gdG8gdGhlIFwiQUFKXCIgcHJvYmxlbS4gSWYgdGhlIGFjZXMgYXJlIGRyYXduIGZpcnN0XG4vL3RoZXkgd2lsbCBjYXVzZSB0aGUgcGxheWVyIHRvIGJ1c3Qgd2l0aG91dCB0aGlzIGV4dHJhIGxvZ2ljLiBUaGlzIGRvZXMgbm90IGFjY291bnRcbi8vZm9yIGFsbCBwb3NzaWJpbGl0aWVzIGJ1dCB0aGUgY2hhbmNlcyBvZiBiZWluZyBkZWFsdCBzb21ldGhpbmcgbGlrZSBcIkFBQUFBQTVcIlxuLy9hcmUgYXN0cm9ub21pY2FsbHkgbG93LlxuICBzd2l0Y2ggKGFjZXMpIHtcbiAgICBjYXNlIDEgOlxuICAgICAgaWYgKHRvdGFsIDw9IDEwKSB7XG4gICAgICAgIHRvdGFsICs9IDExO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdG90YWwgKz0gMTtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgMiA6XG4gICAgICBpZiAodG90YWwgPD0gOSkge1xuICAgICAgICB0b3RhbCArPSAxMjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRvdGFsICs9IDI7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgICBjYXNlIDMgOlxuICAgICAgaWYgKHRvdGFsIDw9IDgpIHtcbiAgICAgICAgdG90YWwgKz0gMTM7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0b3RhbCArPSAzO1xuICAgICAgfVxuICAgICAgYnJlYWs7XG4gICAgY2FzZSA0IDpcbiAgICAgIGlmICh0b3RhbCA8PSA3KSB7XG4gICAgICAgIHRvdGFsICs9IDE0O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdG90YWwgKz0gNDtcbiAgICAgIH1cbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgNSA6XG4gICAgICBpZiAodG90YWwgPD0gNikge1xuICAgICAgICB0b3RhbCArPSAxNTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRvdGFsICs9IDU7XG4gICAgICB9XG4gICAgICBicmVhaztcbiAgfVxuXG4gIHBlcnNvbiA9PT0gXCJkZWFsZXJcIiA/IGdhbWUuZGVhbGVyVG90YWwgPSB0b3RhbCA6IGdhbWUucGxheWVyVG90YWwgPSB0b3RhbDtcbn1cblxuZnVuY3Rpb24gY2hlY2tWaWN0b3J5KCkge1xuICBpZiAoZ2FtZS5kZWFsZXJUb3RhbCA9PT0gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcImRlYWxlciBoYXMgMjFcIik7XG4gICAgZ2FtZS53aW5uZXIgPSBcImRlYWxlclwiO1xuICAgIHNjb3JlIC09IDE7XG4gICAgYW5ub3VuY2UoXCJZT1UgTE9TRVwiKTtcbiAgfSBlbHNlIGlmIChnYW1lLmRlYWxlclRvdGFsID4gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcImRlYWxlciBidXN0c1wiKTtcbiAgICBnYW1lLndpbm5lciA9IFwicGxheWVyXCI7XG4gICAgc2NvcmUgKz0gMTtcbiAgICBhbm5vdW5jZShcIllPVSBXSU5cIik7XG4gIH1cblxuICBpZiAoZ2FtZS5wbGF5ZXJUb3RhbCA9PT0gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcInBsYXllciBoYXMgMjFcIik7XG4gICAgZ2FtZS53aW5uZXIgPSBcInBsYXllclwiO1xuICAgIHNjb3JlICs9IDE7XG4gICAgYW5ub3VuY2UoXCIyMSFcIik7XG4gIH0gZWxzZSBpZiAoZ2FtZS5wbGF5ZXJUb3RhbCA+IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJwbGF5ZXIgYnVzdHNcIik7XG4gICAgZ2FtZS53aW5uZXIgPSBcImRlYWxlclwiO1xuICAgIHNjb3JlIC09IDE7XG4gICAgYW5ub3VuY2UoXCJCVVNUXCIpO1xuICB9XG5cbiAgaWYgKGdhbWUud2lubmVyICE9PSBcIlwiKSB7XG4gICAgZmxpcENhcmQoKTtcbiAgICBnYW1lRW5kKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2FtZUVuZCgpIHtcbiAgdXBkYXRlU2NvcmUoKTtcbiAgJG5ld0dhbWUuYXR0cihcImRpc2FibGVkXCIsIGZhbHNlKTtcbiAgJGhpdC5hdHRyKFwiZGlzYWJsZWRcIiwgdHJ1ZSk7XG4gICRzdGF5LmF0dHIoXCJkaXNhYmxlZFwiLCB0cnVlKTtcbn1cblxuZnVuY3Rpb24gY2xlYXJUYWJsZSgpIHtcbiAgJGRlYWxlci5lbXB0eSgpO1xuICAkcGxheWVyLmVtcHR5KCk7XG4gICRhbm5vdW5jZS5yZW1vdmVDbGFzcyhcIndpbiBsb3NlIHB1c2hcIik7XG4gIGNvbnNvbGUubG9nKFwiLS10YWJsZSBjbGVhcmVkLS1cIik7XG59XG5cbmZ1bmN0aW9uIGNhcmRJbWFnZShkYXRhKSB7XG4gIHZhciBjYXJkVmFsdWUgPSBkYXRhLmNhcmRzWzBdLnZhbHVlO1xuICB2YXIgY2FyZFN1aXQgPSBkYXRhLmNhcmRzWzBdLnN1aXQ7XG4gIHZhciBmaWxlbmFtZSA9IFwiLi4vaW1hZ2VzL2NhcmRzL1wiICsgY2FyZFZhbHVlICsgXCJfb2ZfXCIgKyBjYXJkU3VpdC50b0xvd2VyQ2FzZSgpICsgXCIuc3ZnXCI7XG4gIHJldHVybiBmaWxlbmFtZTtcbn1cblxuZnVuY3Rpb24gYW5ub3VuY2UodGV4dCkge1xuICBpZiAoZ2FtZS53aW5uZXIgPT09IFwiZGVhbGVyXCIpIHtcbiAgICAkYW5ub3VuY2UuYWRkQ2xhc3MoXCJsb3NlXCIpO1xuICAgIGxvc2VXYXYubG9hZCgpO1xuICAgIGxvc2VXYXYucGxheSgpO1xuICB9IGVsc2UgaWYgKGdhbWUud2lubmVyID09PSBcInBsYXllclwiKSB7XG4gICAgJGFubm91bmNlLmFkZENsYXNzKFwid2luXCIpO1xuICAgIHdpbldhdi5sb2FkKCk7XG4gICAgd2luV2F2LnBsYXkoKTtcbiAgfSBlbHNlIGlmIChnYW1lLndpbm5lciA9PT0gXCJwdXNoXCIpIHtcbiAgICAkYW5ub3VuY2UuYWRkQ2xhc3MoXCJwdXNoXCIpO1xuICB9XG4gICRhbm5vdW5jZVRleHQudGV4dCh0ZXh0KTtcbn1cblxuZnVuY3Rpb24gZmxpcENhcmQoKSB7XG4gIHZhciAkZmxpcHBlZCA9ICQoXCIuZGVhbGVyIC5jYXJkSW1hZ2VcIik7XG4gICRmbGlwcGVkLmZpcnN0KCkuYXR0cihcInNyY1wiLCBnYW1lLmhpZGRlbkNhcmQpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVTY29yZSgpIHtcbiAgJHNjb3JlLmVtcHR5KCk7XG4gICRzY29yZS5hcHBlbmQoXCI8cD5TY29yZTogXCIgKyBzY29yZSArIFwiPC9wPlwiKTtcbn1cblxuZnVuY3Rpb24gdXBkYXRlQ291bnQoY2FyZCkge1xuICBpZiAoaXNOYU4oTnVtYmVyKGNhcmQpKSB8fCBjYXJkID09PSBcIjEwXCIpIHtcbiAgICBjb3VudCAtPSAxO1xuICB9IGVsc2UgaWYgKGNhcmQgPCA3KSB7XG4gICAgY291bnQgKz0gMTtcbiAgfVxuICAkY291bnQuZW1wdHkoKTtcbiAgJGNvdW50LmFwcGVuZChcIjxwPkNvdW50OiBcIiArIGNvdW50ICsgXCI8L3A+XCIpO1xufVxuXG4vLyBKU09OIHJlcXVlc3QgZnVuY3Rpb24gd2l0aCBKU09OUCBwcm94eVxuZnVuY3Rpb24gZ2V0SlNPTih1cmwsIGNiKSB7XG4gIHZhciBKU09OUF9QUk9YWSA9ICdodHRwczovL2pzb25wLmFmZWxkLm1lLz91cmw9JztcbiAgLy8gVEhJUyBXSUxMIEFERCBUSEUgQ1JPU1MgT1JJR0lOIEhFQURFUlNcbiAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgcmVxdWVzdC5vcGVuKCdHRVQnLCBKU09OUF9QUk9YWSArIHVybCk7XG4gIHJlcXVlc3Qub25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiByZXF1ZXN0LnN0YXR1cyA8IDQwMCkge1xuICAgICAgY2IoSlNPTi5wYXJzZShyZXF1ZXN0LnJlc3BvbnNlVGV4dCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjYihKU09OLnBhcnNlKHJlcXVlc3QucmVzcG9uc2VUZXh0KSk7XG4gICAgfVxuICB9O1xuICByZXF1ZXN0LnNlbmQoKTtcbn1cbiJdfQ==