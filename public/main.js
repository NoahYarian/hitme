"use strict";

var API = "http://deckofcardsapi.com/api/";
var deckId;

//buttons
var $dealCards = $(".dealCards");
var $sameDeckDeal = $(".sameDeckDeal");
var $hit = $(".hit");
var $stay = $(".stay");
var $reset = $(".reset");

//scoreboard divs
var $score = $(".score");
var $count = $(".count");

//card hands
var $dealer = $(".dealer");
var $player = $(".player");

var dealerHandMax = [];
var playerHandMax = [];
var dealerHandMin = [];
var playerHandMin = [];
var dealerTotalMax;
var playerTotalMax;
var dealerTotalMin;
var playerTotalMin;
var winner;
var score = 0;
var count = 0;

$dealCards.click(deal);
$sameDeckDeal.click(sameDeckDeal);
$hit.click(hit);
$stay.click(stay);
$reset.click(reset);

// deal a new hand from a new deck
function deal() {
  var shuffleURL = API + "shuffle/?deck_count=6";
  count = 0;
  reset();
  console.log("shuffleURL = " + shuffleURL);
  getJSON(shuffleURL, function (data) {
    deckId = data.deck_id;
    console.log("deckId = " + deckId);
    dealerCard();
    playerCard();
    dealerCard();
    playerCard();
  });
}

// deal a new hand from the same deck
function sameDeckDeal() {
  reset();
  dealerCard();
  playerCard();
  dealerCard();
  playerCard();
}

function hit() {
  console.log("hit");
  playerCard();
  if (!winner && dealerTotalMin < 17) {
    dealerCard();
  } else {
    if (dealerTotalMax < 22) {
      console.log("dealer stays at " + dealerTotalMax);
    } else {
      console.log("dealer stays at " + dealerTotalMin);
    }
  }
}

function stay() {
  console.log("stay");
  var dealerTotalFinal = dealerTotalMax < 22 ? dealerTotalMax : dealerTotalMin;
  var playerTotalFinal = playerTotalMax < 22 ? playerTotalMax : playerTotalMin;

  if (dealerTotalMin < 17) {
    dealerCard();
  } else {
    dealerTotalFinal >= playerTotalFinal ? (winner = "dealer", score -= 1, console.log("dealer's " + dealerTotalFinal + "beats player's " + playerTotalFinal)) : (winner = "player", score += 1, console.log("player's " + playerTotalFinal + " beats dealer's " + dealerTotalFinal));
    checkGame();
  }
}

// deal dealer one card
function dealerCard() {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data) {
    var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
    $dealer.append(html);

    dealerHandMax.push(convertCardMax(data.cards[0].value));
    dealerTotalMax = getTotal(dealerHandMax);
    dealerHandMin.push(convertCardMin(data.cards[0].value));
    dealerTotalMin = getTotal(dealerHandMin);

    if (dealerTotalMin === dealerTotalMax) {
      console.log("dealer's hand - " + dealerHandMax + " **** dealer is at " + dealerTotalMax);
    } else {
      console.log("dealer's hand - " + dealerHandMax + " or " + dealerHandMin + " **** dealer is at " + dealerTotalMax + " or " + dealerTotalMin);
    }

    whatsTheCount(convertCardMax(data.cards[0].value));
    checkGame();
  });
}

// deal player one card
function playerCard() {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data) {
    var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
    $player.append(html);

    playerHandMax.push(convertCardMax(data.cards[0].value));
    playerTotalMax = getTotal(playerHandMax);
    playerHandMin.push(convertCardMin(data.cards[0].value));
    playerTotalMin = getTotal(playerHandMin);

    if (playerTotalMin === playerTotalMax) {
      console.log("player's hand - " + playerHandMax + " **** player is at " + playerTotalMax);
    } else {
      console.log("player's hand - " + playerHandMax + " or " + playerHandMin + " **** player is at " + playerTotalMax + " or " + playerTotalMin);
    }

    whatsTheCount(convertCardMax(data.cards[0].value));
    checkGame();
  });
}

// converts JSON string values in card hard arrays to numbers
function convertCardMax(value) {
  if (value === "ACE") {
    return 11;
  } else if (isNaN(value)) {
    return 10;
  } else {
    return Number(value);
  }
}

function convertCardMin(value) {
  if (value === "ACE") {
    return 1;
  } else if (isNaN(value)) {
    return 10;
  } else {
    return Number(value);
  }
}

// reduces card hand arrays to totals
function getTotal(hand) {
  var total = hand.reduce(function (prev, curr) {
    return prev + curr;
  });
  return total;
}

// looks for victory conditions and triggers game reset and scorekeeping
function checkGame() {
  if (dealerTotalMax === 21 || dealerTotalMin === 21) {
    console.log("Dealer has 21");
    winner = "dealer";
    score -= 1;
  } else if (dealerTotalMin > 21) {
    console.log("Dealer busts");
    winner = "player";
    score += 1;
  }

  if (playerTotalMax === 21 || playerTotalMin === 21) {
    console.log("Player has 21");
    winner = "player";
    score += 1;
  } else if (playerTotalMin > 21) {
    console.log("Player busts");
    winner = "dealer";
    score -= 1;
  }

  if (winner) {
    updateScore();
    reset();
  }
}

// adds 1 or subtracts 1 from scoreboard
function updateScore() {
  $score.empty();
  $score.append(score);
}

// clears card images and resets game values to initial
function reset() {
  $dealer.empty();
  $player.empty();
  dealerHandMax = [];
  playerHandMax = [];
  dealerHandMin = [];
  playerHandMin = [];
  dealerTotalMax = 0;
  playerTotalMax = 0;
  dealerTotalMin = 0;
  playerTotalMin = 0;
  winner = null;
  console.log("--reset--");
}

function whatsTheCount(num) {
  if (num < 7) {
    count += 1;
  } else if (num > 9) {
    count -= 1;
  }
  $count.empty();
  $count.append(count);
}

// JSON request function with JSONP proxy
function getJSON(url, cb) {
  var JSONP_PROXY = "https://jsonp.afeld.me/?url=";
  // THIS WILL ADD THE CROSS ORIGIN HEADERS
  var request = new XMLHttpRequest();
  request.open("GET", JSONP_PROXY + url);
  request.onload = function () {
    if (request.status >= 200 && request.status < 400) {
      cb(JSON.parse(request.responseText));
    }
  };
  request.send();
}
//# sourceMappingURL=data:application/json;base64,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Q0FBQyxNQUFNLEdBQUcsWUFBVztBQUMxQixRQUFJLE9BQU8sQ0FBQyxNQUFNLElBQUksR0FBRyxJQUFJLE9BQU8sQ0FBQyxNQUFNLEdBQUcsR0FBRyxFQUFFO0FBQ2pELFFBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxZQUFZLENBQUMsQ0FBQyxDQUFDO0tBQ3RDO0dBQ0YsQ0FBQztBQUNGLFNBQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztDQUNoQiIsImZpbGUiOiJzcmMvbWFpbi5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBBUEkgPSBcImh0dHA6Ly9kZWNrb2ZjYXJkc2FwaS5jb20vYXBpL1wiO1xudmFyIGRlY2tJZDtcblxuLy9idXR0b25zXG52YXIgJGRlYWxDYXJkcyA9ICQoXCIuZGVhbENhcmRzXCIpO1xudmFyICRzYW1lRGVja0RlYWwgPSAkKFwiLnNhbWVEZWNrRGVhbFwiKTtcbnZhciAkaGl0ID0gJChcIi5oaXRcIik7XG52YXIgJHN0YXkgPSAkKFwiLnN0YXlcIik7XG52YXIgJHJlc2V0ID0gJChcIi5yZXNldFwiKTtcblxuLy9zY29yZWJvYXJkIGRpdnNcbnZhciAkc2NvcmUgPSAkKFwiLnNjb3JlXCIpO1xudmFyICRjb3VudCA9ICQoXCIuY291bnRcIik7XG5cbi8vY2FyZCBoYW5kc1xudmFyICRkZWFsZXIgPSAkKFwiLmRlYWxlclwiKTtcbnZhciAkcGxheWVyID0gJChcIi5wbGF5ZXJcIik7XG5cblxudmFyIGRlYWxlckhhbmRNYXggPSBbXTtcbnZhciBwbGF5ZXJIYW5kTWF4ID0gW107XG52YXIgZGVhbGVySGFuZE1pbiA9IFtdO1xudmFyIHBsYXllckhhbmRNaW4gPSBbXTtcbnZhciBkZWFsZXJUb3RhbE1heDtcbnZhciBwbGF5ZXJUb3RhbE1heDtcbnZhciBkZWFsZXJUb3RhbE1pbjtcbnZhciBwbGF5ZXJUb3RhbE1pbjtcbnZhciB3aW5uZXI7XG52YXIgc2NvcmUgPSAwO1xudmFyIGNvdW50ID0gMDtcblxuJGRlYWxDYXJkcy5jbGljayhkZWFsKTtcbiRzYW1lRGVja0RlYWwuY2xpY2soc2FtZURlY2tEZWFsKTtcbiRoaXQuY2xpY2soaGl0KTtcbiRzdGF5LmNsaWNrKHN0YXkpO1xuJHJlc2V0LmNsaWNrKHJlc2V0KTtcblxuLy8gZGVhbCBhIG5ldyBoYW5kIGZyb20gYSBuZXcgZGVja1xuZnVuY3Rpb24gZGVhbCgpIHtcbiAgdmFyIHNodWZmbGVVUkwgPSBBUEkgKyBcInNodWZmbGUvP2RlY2tfY291bnQ9NlwiO1xuICBjb3VudCA9IDA7XG4gIHJlc2V0KCk7XG4gIGNvbnNvbGUubG9nKFwic2h1ZmZsZVVSTCA9IFwiICsgc2h1ZmZsZVVSTCk7XG4gIGdldEpTT04oc2h1ZmZsZVVSTCwgZnVuY3Rpb24oZGF0YSkge1xuICAgIGRlY2tJZCA9IGRhdGEuZGVja19pZDtcbiAgICBjb25zb2xlLmxvZyhcImRlY2tJZCA9IFwiICsgZGVja0lkKTtcbiAgICBkZWFsZXJDYXJkKCk7XG4gICAgcGxheWVyQ2FyZCgpO1xuICAgIGRlYWxlckNhcmQoKTtcbiAgICBwbGF5ZXJDYXJkKCk7XG4gIH0pO1xufVxuXG4vLyBkZWFsIGEgbmV3IGhhbmQgZnJvbSB0aGUgc2FtZSBkZWNrXG5mdW5jdGlvbiBzYW1lRGVja0RlYWwoKSB7XG4gICAgcmVzZXQoKTtcbiAgICBkZWFsZXJDYXJkKCk7XG4gICAgcGxheWVyQ2FyZCgpO1xuICAgIGRlYWxlckNhcmQoKTtcbiAgICBwbGF5ZXJDYXJkKCk7XG59XG5cbmZ1bmN0aW9uIGhpdCgpIHtcbiAgY29uc29sZS5sb2coXCJoaXRcIik7XG4gIHBsYXllckNhcmQoKTtcbiAgaWYgKCF3aW5uZXIgJiYgZGVhbGVyVG90YWxNaW4gPCAxNykge1xuICAgIGRlYWxlckNhcmQoKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoZGVhbGVyVG90YWxNYXggPCAyMikge1xuICAgICAgY29uc29sZS5sb2coXCJkZWFsZXIgc3RheXMgYXQgXCIgKyBkZWFsZXJUb3RhbE1heCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyIHN0YXlzIGF0IFwiICsgZGVhbGVyVG90YWxNaW4pO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBzdGF5KCkge1xuICBjb25zb2xlLmxvZyhcInN0YXlcIik7XG4gIHZhciBkZWFsZXJUb3RhbEZpbmFsID0gKGRlYWxlclRvdGFsTWF4IDwgMjIpID8gZGVhbGVyVG90YWxNYXggOiBkZWFsZXJUb3RhbE1pbjtcbiAgdmFyIHBsYXllclRvdGFsRmluYWwgPSAocGxheWVyVG90YWxNYXggPCAyMikgPyBwbGF5ZXJUb3RhbE1heCA6IHBsYXllclRvdGFsTWluO1xuXG4gIGlmIChkZWFsZXJUb3RhbE1pbiA8IDE3KSB7XG4gICAgZGVhbGVyQ2FyZCgpO1xuICB9IGVsc2Uge1xuICAgIGRlYWxlclRvdGFsRmluYWwgPj0gcGxheWVyVG90YWxGaW5hbCA/XG4gICAgICAod2lubmVyID0gXCJkZWFsZXJcIiwgc2NvcmUgLT0gMSwgY29uc29sZS5sb2coXCJkZWFsZXIncyBcIiArIGRlYWxlclRvdGFsRmluYWwgKyBcImJlYXRzIHBsYXllcidzIFwiICsgcGxheWVyVG90YWxGaW5hbCkpIDpcbiAgICAgICh3aW5uZXIgPSBcInBsYXllclwiLCBzY29yZSArPSAxLCBjb25zb2xlLmxvZyhcInBsYXllcidzIFwiICsgcGxheWVyVG90YWxGaW5hbCArIFwiIGJlYXRzIGRlYWxlcidzIFwiICsgZGVhbGVyVG90YWxGaW5hbCkpO1xuICAgIGNoZWNrR2FtZSgpO1xuICB9XG59XG5cbi8vIGRlYWwgZGVhbGVyIG9uZSBjYXJkXG5mdW5jdGlvbiBkZWFsZXJDYXJkKCl7XG4gIHZhciBjYXJkVVJMID0gQVBJICsgXCJkcmF3L1wiICsgZGVja0lkICsgXCIvP2NvdW50PTFcIjtcbiAgZ2V0SlNPTihjYXJkVVJMLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgdmFyIGh0bWwgPSBcIjxpbWcgY2xhc3M9J2NhcmRJbWFnZScgc3JjPSdcIiArIGRhdGEuY2FyZHNbMF0uaW1hZ2UgKyBcIic+XCI7XG4gICAgJGRlYWxlci5hcHBlbmQoaHRtbCk7XG5cbiAgICBkZWFsZXJIYW5kTWF4LnB1c2goY29udmVydENhcmRNYXgoZGF0YS5jYXJkc1swXS52YWx1ZSkpO1xuICAgIGRlYWxlclRvdGFsTWF4ID0gZ2V0VG90YWwoZGVhbGVySGFuZE1heCk7XG4gICAgZGVhbGVySGFuZE1pbi5wdXNoKGNvbnZlcnRDYXJkTWluKGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBkZWFsZXJUb3RhbE1pbiA9IGdldFRvdGFsKGRlYWxlckhhbmRNaW4pO1xuXG4gICAgaWYgKGRlYWxlclRvdGFsTWluID09PSBkZWFsZXJUb3RhbE1heCkge1xuICAgICAgY29uc29sZS5sb2coXCJkZWFsZXIncyBoYW5kIC0gXCIgKyBkZWFsZXJIYW5kTWF4ICsgXCIgKioqKiBkZWFsZXIgaXMgYXQgXCIgKyBkZWFsZXJUb3RhbE1heCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyJ3MgaGFuZCAtIFwiICsgZGVhbGVySGFuZE1heCArIFwiIG9yIFwiICsgZGVhbGVySGFuZE1pbiArIFwiICoqKiogZGVhbGVyIGlzIGF0IFwiICsgZGVhbGVyVG90YWxNYXggKyBcIiBvciBcIiArIGRlYWxlclRvdGFsTWluKTtcbiAgICB9XG5cbiAgICB3aGF0c1RoZUNvdW50KGNvbnZlcnRDYXJkTWF4KGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBjaGVja0dhbWUoKTtcbiAgfSk7XG59XG5cbi8vIGRlYWwgcGxheWVyIG9uZSBjYXJkXG5mdW5jdGlvbiBwbGF5ZXJDYXJkKCl7XG4gIHZhciBjYXJkVVJMID0gQVBJICsgXCJkcmF3L1wiICsgZGVja0lkICsgXCIvP2NvdW50PTFcIjtcbiAgZ2V0SlNPTihjYXJkVVJMLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgdmFyIGh0bWwgPSBcIjxpbWcgY2xhc3M9J2NhcmRJbWFnZScgc3JjPSdcIiArIGRhdGEuY2FyZHNbMF0uaW1hZ2UgKyBcIic+XCI7XG4gICAgJHBsYXllci5hcHBlbmQoaHRtbCk7XG5cbiAgICBwbGF5ZXJIYW5kTWF4LnB1c2goY29udmVydENhcmRNYXgoZGF0YS5jYXJkc1swXS52YWx1ZSkpO1xuICAgIHBsYXllclRvdGFsTWF4ID0gZ2V0VG90YWwocGxheWVySGFuZE1heCk7XG4gICAgcGxheWVySGFuZE1pbi5wdXNoKGNvbnZlcnRDYXJkTWluKGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBwbGF5ZXJUb3RhbE1pbiA9IGdldFRvdGFsKHBsYXllckhhbmRNaW4pO1xuXG4gICAgaWYgKHBsYXllclRvdGFsTWluID09PSBwbGF5ZXJUb3RhbE1heCkge1xuICAgICAgY29uc29sZS5sb2coXCJwbGF5ZXIncyBoYW5kIC0gXCIgKyBwbGF5ZXJIYW5kTWF4ICsgXCIgKioqKiBwbGF5ZXIgaXMgYXQgXCIgKyBwbGF5ZXJUb3RhbE1heCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKFwicGxheWVyJ3MgaGFuZCAtIFwiICsgcGxheWVySGFuZE1heCArIFwiIG9yIFwiICsgcGxheWVySGFuZE1pbiArIFwiICoqKiogcGxheWVyIGlzIGF0IFwiICsgcGxheWVyVG90YWxNYXggKyBcIiBvciBcIiArIHBsYXllclRvdGFsTWluKTtcbiAgICB9XG5cbiAgICB3aGF0c1RoZUNvdW50KGNvbnZlcnRDYXJkTWF4KGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBjaGVja0dhbWUoKTtcbiAgfSk7XG59XG5cbi8vIGNvbnZlcnRzIEpTT04gc3RyaW5nIHZhbHVlcyBpbiBjYXJkIGhhcmQgYXJyYXlzIHRvIG51bWJlcnNcbmZ1bmN0aW9uIGNvbnZlcnRDYXJkTWF4KHZhbHVlKSB7XG4gIGlmICh2YWx1ZSA9PT0gXCJBQ0VcIikge1xuICAgIHJldHVybiAxMTtcbiAgfSBlbHNlIGlmIChpc05hTih2YWx1ZSkpIHtcbiAgICByZXR1cm4gMTA7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIE51bWJlcih2YWx1ZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29udmVydENhcmRNaW4odmFsdWUpIHtcbiAgaWYgKHZhbHVlID09PSBcIkFDRVwiKSB7XG4gICAgcmV0dXJuIDE7XG4gIH0gZWxzZSBpZiAoaXNOYU4odmFsdWUpKSB7XG4gICAgcmV0dXJuIDEwO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBOdW1iZXIodmFsdWUpO1xuICB9XG59XG5cbi8vIHJlZHVjZXMgY2FyZCBoYW5kIGFycmF5cyB0byB0b3RhbHNcbmZ1bmN0aW9uIGdldFRvdGFsKGhhbmQpIHtcbiAgdmFyIHRvdGFsID0gaGFuZC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgY3Vycikge1xuICAgIHJldHVybiBwcmV2ICsgY3VycjtcbiAgfSk7XG4gIHJldHVybiB0b3RhbDtcbn1cblxuLy8gbG9va3MgZm9yIHZpY3RvcnkgY29uZGl0aW9ucyBhbmQgdHJpZ2dlcnMgZ2FtZSByZXNldCBhbmQgc2NvcmVrZWVwaW5nXG5mdW5jdGlvbiBjaGVja0dhbWUoKSB7XG4gIGlmIChkZWFsZXJUb3RhbE1heCA9PT0gMjEgfHwgZGVhbGVyVG90YWxNaW4gPT09IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJEZWFsZXIgaGFzIDIxXCIpO1xuICAgIHdpbm5lciA9IFwiZGVhbGVyXCI7XG4gICAgc2NvcmUgLT0gMTtcbiAgfSBlbHNlIGlmIChkZWFsZXJUb3RhbE1pbiA+IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJEZWFsZXIgYnVzdHNcIik7XG4gICAgd2lubmVyID0gXCJwbGF5ZXJcIjtcbiAgICBzY29yZSArPSAxO1xuICB9XG5cbiAgaWYgKHBsYXllclRvdGFsTWF4ID09PSAyMSB8fCBwbGF5ZXJUb3RhbE1pbiA9PT0gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcIlBsYXllciBoYXMgMjFcIik7XG4gICAgd2lubmVyID0gXCJwbGF5ZXJcIjtcbiAgICBzY29yZSArPSAxO1xuICB9IGVsc2UgaWYgKHBsYXllclRvdGFsTWluID4gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcIlBsYXllciBidXN0c1wiKTtcbiAgICB3aW5uZXIgPSBcImRlYWxlclwiO1xuICAgIHNjb3JlIC09IDE7XG4gIH1cblxuICBpZiAod2lubmVyKSB7XG4gICAgdXBkYXRlU2NvcmUoKTtcbiAgICByZXNldCgpO1xuICB9XG59XG5cbi8vIGFkZHMgMSBvciBzdWJ0cmFjdHMgMSBmcm9tIHNjb3JlYm9hcmRcbmZ1bmN0aW9uIHVwZGF0ZVNjb3JlKCkge1xuICAkc2NvcmUuZW1wdHkoKTtcbiAgJHNjb3JlLmFwcGVuZChzY29yZSk7XG59XG5cbi8vIGNsZWFycyBjYXJkIGltYWdlcyBhbmQgcmVzZXRzIGdhbWUgdmFsdWVzIHRvIGluaXRpYWxcbmZ1bmN0aW9uIHJlc2V0KCkge1xuICAkZGVhbGVyLmVtcHR5KCk7XG4gICRwbGF5ZXIuZW1wdHkoKTtcbiAgZGVhbGVySGFuZE1heCA9IFtdO1xuICBwbGF5ZXJIYW5kTWF4ID0gW107XG4gIGRlYWxlckhhbmRNaW4gPSBbXTtcbiAgcGxheWVySGFuZE1pbiA9IFtdO1xuICBkZWFsZXJUb3RhbE1heCA9IDA7XG4gIHBsYXllclRvdGFsTWF4ID0gMDtcbiAgZGVhbGVyVG90YWxNaW4gPSAwO1xuICBwbGF5ZXJUb3RhbE1pbiA9IDA7XG4gIHdpbm5lciA9IG51bGw7XG4gIGNvbnNvbGUubG9nKFwiLS1yZXNldC0tXCIpO1xufVxuXG5mdW5jdGlvbiB3aGF0c1RoZUNvdW50KG51bSkge1xuICBpZiAobnVtIDwgNykge1xuICAgIGNvdW50ICs9IDE7XG4gIH0gZWxzZSBpZiAobnVtID4gOSkge1xuICAgIGNvdW50IC09IDE7XG4gIH1cbiAgJGNvdW50LmVtcHR5KCk7XG4gICRjb3VudC5hcHBlbmQoY291bnQpO1xuXG59XG5cblxuLy8gSlNPTiByZXF1ZXN0IGZ1bmN0aW9uIHdpdGggSlNPTlAgcHJveHlcbmZ1bmN0aW9uIGdldEpTT04odXJsLCBjYikge1xuICB2YXIgSlNPTlBfUFJPWFkgPSAnaHR0cHM6Ly9qc29ucC5hZmVsZC5tZS8/dXJsPSdcbiAgLy8gVEhJUyBXSUxMIEFERCBUSEUgQ1JPU1MgT1JJR0lOIEhFQURFUlNcbiAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgcmVxdWVzdC5vcGVuKCdHRVQnLCBKU09OUF9QUk9YWSArIHVybCk7XG4gIHJlcXVlc3Qub25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiByZXF1ZXN0LnN0YXR1cyA8IDQwMCkge1xuICAgICAgY2IoSlNPTi5wYXJzZShyZXF1ZXN0LnJlc3BvbnNlVGV4dCkpO1xuICAgIH1cbiAgfTtcbiAgcmVxdWVzdC5zZW5kKCk7XG59XG4iXX0=