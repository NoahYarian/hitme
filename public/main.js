"use strict";

var API = "http://deckofcardsapi.com/api/";
var newDeckURL = API + "shuffle/?deck_count=6";
var deckId;

var cardBack = "http://tinyurl.com/kqzzmbr";

//buttons
var $dealCards = $(".dealCards");
//var $sameDeckDeal = $(".sameDeckDeal");
var $hit = $(".hit");
var $stay = $(".stay");
var $reset = $(".reset");

//scoreboard divs
var $score = $(".score");
var $count = $(".count");

//card hand divs
var $dealer = $(".dealer");
var $player = $(".player");

var dealerHand = [];
var playerHand = [];
var playerTotal = 0;
var dealerTotal = 0;

//var dealerHandMax = [];
//var playerHandMax = [];
//var dealerHandMin = [];
//var playerHandMin = [];
//var dealerTotalMax;
//var playerTotalMax;
//var dealerTotalMin;
//var playerTotalMin;
var winner;
var score = 0;
var count = 0;

$dealCards.click(deal);
//$sameDeckDeal.click(sameDeckDeal);
$hit.click(hit);
$stay.click(stay);
$reset.click(reset);

function deal() {
  if (!deckId) {
    getJSON(newDeckURL, function (data) {
      deckId = data.deck_id;
      console.log("About to deal from new deck");
      draw4();
    });
  } else {
    console.log("About to deal from current deck");
    draw4();
  }
}

function draw4() {
  drawCard("dealer", cardBack);
  drawCard("player");
  drawCard("dealer");
  drawCard("player");
}

function drawCard(person, image) {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data) {
    if (image) {
      var html = "<img class='cardImage' src='" + image + "'>";
      $("." + person).append(html);
    } else {
      var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
      $("." + person).append(html);
    }
    if (person === "dealer") {
      dealerHand.push(data.cards[0].value);
    } else if (person === "player") {
      playerHand.push(data.cards[0].value);
    }
    checkDealerTotal();
    checkPlayerTotal();
    checkVictory();
  });
}

function checkPlayerTotal() {
  playerTotal = 0;
  playerHand.forEach(function (card) {
    if (card === "KING" || card === "QUEEN" || card === "JACK") {
      playerTotal += 10;
    } else if (!isNaN(card)) {
      playerTotal += Number(card);
    } else if (card === "ACE") {
      if (playerTotal <= 10) {
        playerTotal += 11;
      } else {
        playerTotal += 1;
      }
    }
  });
  console.log("P" + playerTotal);
}

function checkDealerTotal() {
  dealerTotal = 0;
  dealerHand.forEach(function (card) {
    if (card === "KING" || card === "QUEEN" || card === "JACK") {
      dealerTotal += 10;
    } else if (!isNaN(card)) {
      dealerTotal += Number(card);
    } else if (card === "ACE") {
      if (dealerTotal <= 10) {
        dealerTotal += 11;
      } else {
        dealerTotal += 1;
      }
    }
  });
  console.log("D" + dealerTotal);
}

function checkVictory() {
  if (dealerTotal === 21) {
    console.log("dealer has 21");
    winner = "dealer";
    score -= 1;
  } else if (dealerTotal > 21) {
    console.log("dealer busts");
    winner = "player";
    score += 1;
  }

  if (playerTotal === 21) {
    console.log("player has 21");
    winner = "player";
    score += 1;
  } else if (playerTotal > 21) {
    console.log("player busts");
    winner = "dealer";
    score -= 1;
  }

  if (winner) {
    updateScore();
    clearTable();
  }
}

function clearTable() {
  $dealer.empty();
  $player.empty();
  dealerHand = [];
  playerHand = [];
  dealerTotal = 0;
  playerTotal = 0;
  winner = null;
  console.log("--table cleared--");
}

function hit() {
  console.log("hit");
  debugger;
  playerCard();
  if (!winner && dealerTotalMin < 17) {
    dealerCard();
  } else {
    if (dealerTotalMax < 22) {
      console.log("dealer stays at " + dealerTotalMax);
    } else {
      console.log("dealer stays at " + dealerTotalMin);
    }
  }
}

function stay() {
  console.log("stay");
  var dealerTotalFinal = dealerTotalMax < 22 ? dealerTotalMax : dealerTotalMin;
  var playerTotalFinal = playerTotalMax < 22 ? playerTotalMax : playerTotalMin;

  if (dealerTotalMin < 17) {
    dealerCard();
  } else {
    dealerTotalFinal >= playerTotalFinal ? (winner = "dealer", score -= 1, console.log("dealer's " + dealerTotalFinal + " beats player's " + playerTotalFinal)) : (winner = "player", score += 1, console.log("player's " + playerTotalFinal + " beats dealer's " + dealerTotalFinal));
    checkGame();
  }
}

// deal dealer one card
function dealerCard() {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data) {
    var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
    $dealer.append(html);

    dealerHandMax.push(convertCardMax(data.cards[0].value));
    dealerTotalMax = getTotal(dealerHandMax);
    dealerHandMin.push(convertCardMin(data.cards[0].value));
    dealerTotalMin = getTotal(dealerHandMin);

    if (dealerTotalMin === dealerTotalMax) {
      console.log("dealer's hand - " + dealerHandMax + " **** dealer is at " + dealerTotalMax);
    } else {
      console.log("dealer's hand - " + dealerHandMax + " or " + dealerHandMin + " **** dealer is at " + dealerTotalMax + " or " + dealerTotalMin);
    }

    whatsTheCount(convertCardMax(data.cards[0].value));
    checkGame();
  });
}

// deal player one card
function playerCard() {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data) {
    var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
    $player.append(html);

    playerHandMax.push(convertCardMax(data.cards[0].value));
    playerTotalMax = getTotal(playerHandMax);
    playerHandMin.push(convertCardMin(data.cards[0].value));
    playerTotalMin = getTotal(playerHandMin);

    if (playerTotalMin === playerTotalMax) {
      console.log("player's hand - " + playerHandMax + " **** player is at " + playerTotalMax);
    } else {
      console.log("player's hand - " + playerHandMax + " or " + playerHandMin + " **** player is at " + playerTotalMax + " or " + playerTotalMin);
    }

    whatsTheCount(convertCardMax(data.cards[0].value));
    checkGame();
  });
}

// converts JSON string values in card hard arrays to numbers
function convertCardMax(value) {
  if (value === "ACE") {
    return 11;
  } else if (isNaN(value)) {
    return 10;
  } else {
    return Number(value);
  }
}

function convertCardMin(value) {
  if (value === "ACE") {
    return 1;
  } else if (isNaN(value)) {
    return 10;
  } else {
    return Number(value);
  }
}

// reduces card hand arrays to totals
function getTotal(hand) {
  var total = hand.reduce(function (prev, curr) {
    return prev + curr;
  });
  return total;
}

// looks for victory conditions and triggers game reset and scorekeeping
function checkGame() {
  if (dealerTotalMax === 21 || dealerTotalMin === 21) {
    console.log("dealer has 21");
    winner = "dealer";
    score -= 1;
  } else if (dealerTotalMin > 21) {
    console.log("dealer busts");
    winner = "player";
    score += 1;
  }

  if (playerTotalMax === 21 || playerTotalMin === 21) {
    console.log("player has 21");
    winner = "player";
    score += 1;
  } else if (playerTotalMin > 21) {
    console.log("player busts");
    winner = "dealer";
    score -= 1;
  }

  if (winner) {
    updateScore();
    reset();
  }
}

// adds 1 or subtracts 1 from scoreboard
function updateScore() {
  $score.empty();
  $score.append(score);
}

function whatsTheCount(num) {
  if (num < 7) {
    count += 1;
  } else if (num > 9) {
    count -= 1;
  }
  $count.empty();
  $count.append(count);
}

// JSON request function with JSONP proxy
function getJSON(url, cb) {
  var JSONP_PROXY = "https://jsonp.afeld.me/?url=";
  // THIS WILL ADD THE CROSS ORIGIN HEADERS
  var request = new XMLHttpRequest();
  request.open("GET", JSONP_PROXY + url);
  request.onload = function () {
    if (request.status >= 200 && request.status < 400) {
      cb(JSON.parse(request.responseText));
    }
  };
  request.send();
}

/////////////////
//the graveyard//
/////////////////

////function draw4() {
//drawDealerCard(cardBack);
//drawPlayerCard();
//drawDealerCard();
//drawPlayerCard();
//}

//function drawDealerCard(image) {
//var cardURL = API + "draw/" + deckId + "/?count=1";
//getJSON(cardURL, function(data) {
//if (image) {
//var html = "<img class='cardImage' src='" + image + "'>";
//$dealer.append(html);
//} else {
//var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
//$dealer.append(html);
//}
//dealerHand.push(data.cards[0].value);
//checkDealerTotal();
//checkVictory();
//});
//}

//function drawPlayerCard() {
//var cardURL = API + "draw/" + deckId + "/?count=1";
//getJSON(cardURL, function(data) {
//var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
//$player.append(html);
//playerHand.push(data.cards[0].value);
//checkPlayerTotal();
//checkVictory();
//});
//}

// deal a new hand from a new deck
//function deal() {
//var shuffleURL = API + "shuffle/?deck_count=6";
//count = 0;
//reset();
//console.log("shuffleURL = " + shuffleURL);
//getJSON(shuffleURL, function(data) {
//deckId = data.deck_id;
//console.log("deckId = " + deckId);
//dealerCard();
//playerCard();
//dealerCard();
//playerCard();
//});
//}

//// deal a new hand from the same deck
//function sameDeckDeal() {
//reset();
//dealerCard();
//playerCard();
//dealerCard();
//playerCard();
//}
//
//// clears card images and resets game values to initial
//function reset() {
//$dealer.empty();
//$player.empty();
//dealerHandMax = [];
//playerHandMax = [];
//dealerHandMin = [];
//playerHandMin = [];
//dealerTotalMax = 0;
//playerTotalMax = 0;
//dealerTotalMin = 0;
//playerTotalMin = 0;
//winner = null;
//console.log("--reset--");
//}
//# sourceMappingURL=data:application/json;base64,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QUFDbEIsU0FBSyxJQUFJLENBQUMsQ0FBQztHQUNaO0FBQ0QsUUFBTSxDQUFDLEtBQUssRUFBRSxDQUFDO0FBQ2YsUUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztDQUV0Qjs7O0FBSUQsU0FBUyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsRUFBRTtBQUN4QixNQUFJLFdBQVcsR0FBRyw4QkFBOEIsQ0FBQTs7QUFFaEQsTUFBSSxPQUFPLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztBQUNuQyxTQUFPLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxXQUFXLEdBQUcsR0FBRyxDQUFDLENBQUM7QUFDdkMsU0FBTyxDQUFDLE1BQU0sR0FBRyxZQUFXO0FBQzFCLFFBQUksT0FBTyxDQUFDLE1BQU0sSUFBSSxHQUFHLElBQUksT0FBTyxDQUFDLE1BQU0sR0FBRyxHQUFHLEVBQUU7QUFDakQsUUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFlBQVksQ0FBQyxDQUFDLENBQUM7S0FDdEM7R0FDRixDQUFDO0FBQ0YsU0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO0NBQ2hCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBIiwiZmlsZSI6InNyYy9tYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEFQSSA9IFwiaHR0cDovL2RlY2tvZmNhcmRzYXBpLmNvbS9hcGkvXCI7XG52YXIgbmV3RGVja1VSTCA9IEFQSSArIFwic2h1ZmZsZS8/ZGVja19jb3VudD02XCI7XG52YXIgZGVja0lkO1xuXG52YXIgY2FyZEJhY2sgPSBcImh0dHA6Ly90aW55dXJsLmNvbS9rcXp6bWJyXCI7XG5cbi8vYnV0dG9uc1xudmFyICRkZWFsQ2FyZHMgPSAkKFwiLmRlYWxDYXJkc1wiKTtcbi8vdmFyICRzYW1lRGVja0RlYWwgPSAkKFwiLnNhbWVEZWNrRGVhbFwiKTtcbnZhciAkaGl0ID0gJChcIi5oaXRcIik7XG52YXIgJHN0YXkgPSAkKFwiLnN0YXlcIik7XG52YXIgJHJlc2V0ID0gJChcIi5yZXNldFwiKTtcblxuLy9zY29yZWJvYXJkIGRpdnNcbnZhciAkc2NvcmUgPSAkKFwiLnNjb3JlXCIpO1xudmFyICRjb3VudCA9ICQoXCIuY291bnRcIik7XG5cbi8vY2FyZCBoYW5kIGRpdnNcbnZhciAkZGVhbGVyID0gJChcIi5kZWFsZXJcIik7XG52YXIgJHBsYXllciA9ICQoXCIucGxheWVyXCIpO1xuXG52YXIgZGVhbGVySGFuZCA9IFtdO1xudmFyIHBsYXllckhhbmQgPSBbXTtcbnZhciBwbGF5ZXJUb3RhbCA9IDA7XG52YXIgZGVhbGVyVG90YWwgPSAwO1xuXG4vL3ZhciBkZWFsZXJIYW5kTWF4ID0gW107XG4vL3ZhciBwbGF5ZXJIYW5kTWF4ID0gW107XG4vL3ZhciBkZWFsZXJIYW5kTWluID0gW107XG4vL3ZhciBwbGF5ZXJIYW5kTWluID0gW107XG4vL3ZhciBkZWFsZXJUb3RhbE1heDtcbi8vdmFyIHBsYXllclRvdGFsTWF4O1xuLy92YXIgZGVhbGVyVG90YWxNaW47XG4vL3ZhciBwbGF5ZXJUb3RhbE1pbjtcbnZhciB3aW5uZXI7XG52YXIgc2NvcmUgPSAwO1xudmFyIGNvdW50ID0gMDtcblxuJGRlYWxDYXJkcy5jbGljayhkZWFsKTtcbi8vJHNhbWVEZWNrRGVhbC5jbGljayhzYW1lRGVja0RlYWwpO1xuJGhpdC5jbGljayhoaXQpO1xuJHN0YXkuY2xpY2soc3RheSk7XG4kcmVzZXQuY2xpY2socmVzZXQpO1xuXG5mdW5jdGlvbiBkZWFsKCkge1xuICBpZiAoIWRlY2tJZCkge1xuICAgIGdldEpTT04obmV3RGVja1VSTCwgZnVuY3Rpb24oZGF0YSkge1xuICAgICAgZGVja0lkID0gZGF0YS5kZWNrX2lkO1xuICAgICAgY29uc29sZS5sb2coXCJBYm91dCB0byBkZWFsIGZyb20gbmV3IGRlY2tcIik7XG4gICAgICBkcmF3NCgpO1xuICAgIH0pO1xuICB9IGVsc2Uge1xuICAgIGNvbnNvbGUubG9nKFwiQWJvdXQgdG8gZGVhbCBmcm9tIGN1cnJlbnQgZGVja1wiKTtcbiAgICBkcmF3NCgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGRyYXc0KCkge1xuICBkcmF3Q2FyZChcImRlYWxlclwiLCBjYXJkQmFjayk7XG4gIGRyYXdDYXJkKFwicGxheWVyXCIpO1xuICBkcmF3Q2FyZChcImRlYWxlclwiKTtcbiAgZHJhd0NhcmQoXCJwbGF5ZXJcIik7XG59XG5cbmZ1bmN0aW9uIGRyYXdDYXJkKHBlcnNvbiwgaW1hZ2UpIHtcbiAgdmFyIGNhcmRVUkwgPSBBUEkgKyBcImRyYXcvXCIgKyBkZWNrSWQgKyBcIi8/Y291bnQ9MVwiO1xuICBnZXRKU09OKGNhcmRVUkwsIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICBpZiAoaW1hZ2UpIHtcbiAgICAgIHZhciBodG1sID0gXCI8aW1nIGNsYXNzPSdjYXJkSW1hZ2UnIHNyYz0nXCIgKyBpbWFnZSArIFwiJz5cIjtcbiAgICAgICQoXCIuXCIgKyBwZXJzb24pLmFwcGVuZChodG1sKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmFyIGh0bWwgPSBcIjxpbWcgY2xhc3M9J2NhcmRJbWFnZScgc3JjPSdcIiArIGRhdGEuY2FyZHNbMF0uaW1hZ2UgKyBcIic+XCI7XG4gICAgICAkKFwiLlwiICsgcGVyc29uKS5hcHBlbmQoaHRtbCk7XG4gICAgfVxuICAgIGlmIChwZXJzb24gPT09IFwiZGVhbGVyXCIpIHtcbiAgICAgIGRlYWxlckhhbmQucHVzaChkYXRhLmNhcmRzWzBdLnZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKHBlcnNvbiA9PT0gXCJwbGF5ZXJcIikge1xuICAgICAgcGxheWVySGFuZC5wdXNoKGRhdGEuY2FyZHNbMF0udmFsdWUpO1xuICAgIH1cbiAgY2hlY2tEZWFsZXJUb3RhbCgpO1xuICBjaGVja1BsYXllclRvdGFsKCk7XG4gIGNoZWNrVmljdG9yeSgpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gY2hlY2tQbGF5ZXJUb3RhbCgpIHtcbiAgcGxheWVyVG90YWwgPSAwO1xuICBwbGF5ZXJIYW5kLmZvckVhY2goZnVuY3Rpb24oY2FyZCkge1xuICAgIGlmIChjYXJkID09PSBcIktJTkdcIiB8fCBjYXJkID09PSBcIlFVRUVOXCIgfHwgY2FyZCA9PT0gXCJKQUNLXCIpIHtcbiAgICAgIHBsYXllclRvdGFsICs9IDEwO1xuICAgIH0gZWxzZSBpZiAoIWlzTmFOKGNhcmQpKSB7XG4gICAgICBwbGF5ZXJUb3RhbCArPSBOdW1iZXIoY2FyZCk7XG4gICAgfSBlbHNlIGlmIChjYXJkID09PSBcIkFDRVwiKSB7XG4gICAgICBpZiAocGxheWVyVG90YWwgPD0gMTApIHtcbiAgICAgICAgcGxheWVyVG90YWwgKz0gMTE7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwbGF5ZXJUb3RhbCArPSAxO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIGNvbnNvbGUubG9nKFwiUFwiICsgcGxheWVyVG90YWwpO1xufVxuXG5mdW5jdGlvbiBjaGVja0RlYWxlclRvdGFsKCkge1xuICBkZWFsZXJUb3RhbCA9IDA7XG4gIGRlYWxlckhhbmQuZm9yRWFjaChmdW5jdGlvbihjYXJkKSB7XG4gICAgaWYgKGNhcmQgPT09IFwiS0lOR1wiIHx8IGNhcmQgPT09IFwiUVVFRU5cIiB8fCBjYXJkID09PSBcIkpBQ0tcIikge1xuICAgICAgZGVhbGVyVG90YWwgKz0gMTA7XG4gICAgfSBlbHNlIGlmICghaXNOYU4oY2FyZCkpIHtcbiAgICAgIGRlYWxlclRvdGFsICs9IE51bWJlcihjYXJkKTtcbiAgICB9IGVsc2UgaWYgKGNhcmQgPT09IFwiQUNFXCIpIHtcbiAgICAgIGlmIChkZWFsZXJUb3RhbCA8PSAxMCkge1xuICAgICAgICBkZWFsZXJUb3RhbCArPSAxMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlYWxlclRvdGFsICs9IDE7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgY29uc29sZS5sb2coXCJEXCIgKyBkZWFsZXJUb3RhbCk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrVmljdG9yeSgpIHtcbiAgaWYgKGRlYWxlclRvdGFsID09PSAyMSkge1xuICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyIGhhcyAyMVwiKTtcbiAgICB3aW5uZXIgPSBcImRlYWxlclwiO1xuICAgIHNjb3JlIC09IDE7XG4gIH0gZWxzZSBpZiAoZGVhbGVyVG90YWwgPiAyMSkge1xuICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyIGJ1c3RzXCIpO1xuICAgIHdpbm5lciA9IFwicGxheWVyXCI7XG4gICAgc2NvcmUgKz0gMTtcbiAgfVxuXG4gIGlmIChwbGF5ZXJUb3RhbCA9PT0gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcInBsYXllciBoYXMgMjFcIik7XG4gICAgd2lubmVyID0gXCJwbGF5ZXJcIjtcbiAgICBzY29yZSArPSAxO1xuICB9IGVsc2UgaWYgKHBsYXllclRvdGFsID4gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcInBsYXllciBidXN0c1wiKTtcbiAgICB3aW5uZXIgPSBcImRlYWxlclwiO1xuICAgIHNjb3JlIC09IDE7XG4gIH1cblxuICBpZiAod2lubmVyKSB7XG4gICAgdXBkYXRlU2NvcmUoKTtcbiAgICBjbGVhclRhYmxlKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY2xlYXJUYWJsZSgpIHtcbiAgJGRlYWxlci5lbXB0eSgpO1xuICAkcGxheWVyLmVtcHR5KCk7XG4gIGRlYWxlckhhbmQgPSBbXTtcbiAgcGxheWVySGFuZCA9IFtdO1xuICBkZWFsZXJUb3RhbCA9IDA7XG4gIHBsYXllclRvdGFsID0gMDtcbiAgd2lubmVyID0gbnVsbDtcbiAgY29uc29sZS5sb2coXCItLXRhYmxlIGNsZWFyZWQtLVwiKTtcbn1cblxuXG5cblxuXG5mdW5jdGlvbiBoaXQoKSB7XG4gIGNvbnNvbGUubG9nKFwiaGl0XCIpO1xuICBkZWJ1Z2dlcjtcbiAgcGxheWVyQ2FyZCgpO1xuICBpZiAoIXdpbm5lciAmJiBkZWFsZXJUb3RhbE1pbiA8IDE3KSB7XG4gICAgZGVhbGVyQ2FyZCgpO1xuICB9IGVsc2Uge1xuICAgIGlmIChkZWFsZXJUb3RhbE1heCA8IDIyKSB7XG4gICAgICBjb25zb2xlLmxvZyhcImRlYWxlciBzdGF5cyBhdCBcIiArIGRlYWxlclRvdGFsTWF4KTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5sb2coXCJkZWFsZXIgc3RheXMgYXQgXCIgKyBkZWFsZXJUb3RhbE1pbik7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIHN0YXkoKSB7XG4gIGNvbnNvbGUubG9nKFwic3RheVwiKTtcbiAgdmFyIGRlYWxlclRvdGFsRmluYWwgPSAoZGVhbGVyVG90YWxNYXggPCAyMikgPyBkZWFsZXJUb3RhbE1heCA6IGRlYWxlclRvdGFsTWluO1xuICB2YXIgcGxheWVyVG90YWxGaW5hbCA9IChwbGF5ZXJUb3RhbE1heCA8IDIyKSA/IHBsYXllclRvdGFsTWF4IDogcGxheWVyVG90YWxNaW47XG5cbiAgaWYgKGRlYWxlclRvdGFsTWluIDwgMTcpIHtcbiAgICBkZWFsZXJDYXJkKCk7XG4gIH0gZWxzZSB7XG4gICAgZGVhbGVyVG90YWxGaW5hbCA+PSBwbGF5ZXJUb3RhbEZpbmFsID9cbiAgICAgICh3aW5uZXIgPSBcImRlYWxlclwiLCBzY29yZSAtPSAxLCBjb25zb2xlLmxvZyhcImRlYWxlcidzIFwiICsgZGVhbGVyVG90YWxGaW5hbCArIFwiIGJlYXRzIHBsYXllcidzIFwiICsgcGxheWVyVG90YWxGaW5hbCkpIDpcbiAgICAgICh3aW5uZXIgPSBcInBsYXllclwiLCBzY29yZSArPSAxLCBjb25zb2xlLmxvZyhcInBsYXllcidzIFwiICsgcGxheWVyVG90YWxGaW5hbCArIFwiIGJlYXRzIGRlYWxlcidzIFwiICsgZGVhbGVyVG90YWxGaW5hbCkpO1xuICAgIGNoZWNrR2FtZSgpO1xuICB9XG59XG5cbi8vIGRlYWwgZGVhbGVyIG9uZSBjYXJkXG5mdW5jdGlvbiBkZWFsZXJDYXJkKCl7XG4gIHZhciBjYXJkVVJMID0gQVBJICsgXCJkcmF3L1wiICsgZGVja0lkICsgXCIvP2NvdW50PTFcIjtcbiAgZ2V0SlNPTihjYXJkVVJMLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgdmFyIGh0bWwgPSBcIjxpbWcgY2xhc3M9J2NhcmRJbWFnZScgc3JjPSdcIiArIGRhdGEuY2FyZHNbMF0uaW1hZ2UgKyBcIic+XCI7XG4gICAgJGRlYWxlci5hcHBlbmQoaHRtbCk7XG5cbiAgICBkZWFsZXJIYW5kTWF4LnB1c2goY29udmVydENhcmRNYXgoZGF0YS5jYXJkc1swXS52YWx1ZSkpO1xuICAgIGRlYWxlclRvdGFsTWF4ID0gZ2V0VG90YWwoZGVhbGVySGFuZE1heCk7XG4gICAgZGVhbGVySGFuZE1pbi5wdXNoKGNvbnZlcnRDYXJkTWluKGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBkZWFsZXJUb3RhbE1pbiA9IGdldFRvdGFsKGRlYWxlckhhbmRNaW4pO1xuXG4gICAgaWYgKGRlYWxlclRvdGFsTWluID09PSBkZWFsZXJUb3RhbE1heCkge1xuICAgICAgY29uc29sZS5sb2coXCJkZWFsZXIncyBoYW5kIC0gXCIgKyBkZWFsZXJIYW5kTWF4ICsgXCIgKioqKiBkZWFsZXIgaXMgYXQgXCIgKyBkZWFsZXJUb3RhbE1heCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyJ3MgaGFuZCAtIFwiICsgZGVhbGVySGFuZE1heCArIFwiIG9yIFwiICsgZGVhbGVySGFuZE1pbiArIFwiICoqKiogZGVhbGVyIGlzIGF0IFwiICsgZGVhbGVyVG90YWxNYXggKyBcIiBvciBcIiArIGRlYWxlclRvdGFsTWluKTtcbiAgICB9XG5cbiAgICB3aGF0c1RoZUNvdW50KGNvbnZlcnRDYXJkTWF4KGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBjaGVja0dhbWUoKTtcbiAgfSk7XG59XG5cbi8vIGRlYWwgcGxheWVyIG9uZSBjYXJkXG5mdW5jdGlvbiBwbGF5ZXJDYXJkKCl7XG4gIHZhciBjYXJkVVJMID0gQVBJICsgXCJkcmF3L1wiICsgZGVja0lkICsgXCIvP2NvdW50PTFcIjtcbiAgZ2V0SlNPTihjYXJkVVJMLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgdmFyIGh0bWwgPSBcIjxpbWcgY2xhc3M9J2NhcmRJbWFnZScgc3JjPSdcIiArIGRhdGEuY2FyZHNbMF0uaW1hZ2UgKyBcIic+XCI7XG4gICAgJHBsYXllci5hcHBlbmQoaHRtbCk7XG5cbiAgICBwbGF5ZXJIYW5kTWF4LnB1c2goY29udmVydENhcmRNYXgoZGF0YS5jYXJkc1swXS52YWx1ZSkpO1xuICAgIHBsYXllclRvdGFsTWF4ID0gZ2V0VG90YWwocGxheWVySGFuZE1heCk7XG4gICAgcGxheWVySGFuZE1pbi5wdXNoKGNvbnZlcnRDYXJkTWluKGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBwbGF5ZXJUb3RhbE1pbiA9IGdldFRvdGFsKHBsYXllckhhbmRNaW4pO1xuXG4gICAgaWYgKHBsYXllclRvdGFsTWluID09PSBwbGF5ZXJUb3RhbE1heCkge1xuICAgICAgY29uc29sZS5sb2coXCJwbGF5ZXIncyBoYW5kIC0gXCIgKyBwbGF5ZXJIYW5kTWF4ICsgXCIgKioqKiBwbGF5ZXIgaXMgYXQgXCIgKyBwbGF5ZXJUb3RhbE1heCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKFwicGxheWVyJ3MgaGFuZCAtIFwiICsgcGxheWVySGFuZE1heCArIFwiIG9yIFwiICsgcGxheWVySGFuZE1pbiArIFwiICoqKiogcGxheWVyIGlzIGF0IFwiICsgcGxheWVyVG90YWxNYXggKyBcIiBvciBcIiArIHBsYXllclRvdGFsTWluKTtcbiAgICB9XG5cbiAgICB3aGF0c1RoZUNvdW50KGNvbnZlcnRDYXJkTWF4KGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBjaGVja0dhbWUoKTtcbiAgfSk7XG59XG5cbi8vIGNvbnZlcnRzIEpTT04gc3RyaW5nIHZhbHVlcyBpbiBjYXJkIGhhcmQgYXJyYXlzIHRvIG51bWJlcnNcbmZ1bmN0aW9uIGNvbnZlcnRDYXJkTWF4KHZhbHVlKSB7XG4gIGlmICh2YWx1ZSA9PT0gXCJBQ0VcIikge1xuICAgIHJldHVybiAxMTtcbiAgfSBlbHNlIGlmIChpc05hTih2YWx1ZSkpIHtcbiAgICByZXR1cm4gMTA7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIE51bWJlcih2YWx1ZSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gY29udmVydENhcmRNaW4odmFsdWUpIHtcbiAgaWYgKHZhbHVlID09PSBcIkFDRVwiKSB7XG4gICAgcmV0dXJuIDE7XG4gIH0gZWxzZSBpZiAoaXNOYU4odmFsdWUpKSB7XG4gICAgcmV0dXJuIDEwO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBOdW1iZXIodmFsdWUpO1xuICB9XG59XG5cbi8vIHJlZHVjZXMgY2FyZCBoYW5kIGFycmF5cyB0byB0b3RhbHNcbmZ1bmN0aW9uIGdldFRvdGFsKGhhbmQpIHtcbiAgdmFyIHRvdGFsID0gaGFuZC5yZWR1Y2UoZnVuY3Rpb24ocHJldiwgY3Vycikge1xuICAgIHJldHVybiBwcmV2ICsgY3VycjtcbiAgfSk7XG4gIHJldHVybiB0b3RhbDtcbn1cblxuLy8gbG9va3MgZm9yIHZpY3RvcnkgY29uZGl0aW9ucyBhbmQgdHJpZ2dlcnMgZ2FtZSByZXNldCBhbmQgc2NvcmVrZWVwaW5nXG5mdW5jdGlvbiBjaGVja0dhbWUoKSB7XG4gIGlmIChkZWFsZXJUb3RhbE1heCA9PT0gMjEgfHwgZGVhbGVyVG90YWxNaW4gPT09IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJkZWFsZXIgaGFzIDIxXCIpO1xuICAgIHdpbm5lciA9IFwiZGVhbGVyXCI7XG4gICAgc2NvcmUgLT0gMTtcbiAgfSBlbHNlIGlmIChkZWFsZXJUb3RhbE1pbiA+IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJkZWFsZXIgYnVzdHNcIik7XG4gICAgd2lubmVyID0gXCJwbGF5ZXJcIjtcbiAgICBzY29yZSArPSAxO1xuICB9XG5cbiAgaWYgKHBsYXllclRvdGFsTWF4ID09PSAyMSB8fCBwbGF5ZXJUb3RhbE1pbiA9PT0gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcInBsYXllciBoYXMgMjFcIik7XG4gICAgd2lubmVyID0gXCJwbGF5ZXJcIjtcbiAgICBzY29yZSArPSAxO1xuICB9IGVsc2UgaWYgKHBsYXllclRvdGFsTWluID4gMjEpIHtcbiAgICBjb25zb2xlLmxvZyhcInBsYXllciBidXN0c1wiKTtcbiAgICB3aW5uZXIgPSBcImRlYWxlclwiO1xuICAgIHNjb3JlIC09IDE7XG4gIH1cblxuICBpZiAod2lubmVyKSB7XG4gICAgdXBkYXRlU2NvcmUoKTtcbiAgICByZXNldCgpO1xuICB9XG59XG5cbi8vIGFkZHMgMSBvciBzdWJ0cmFjdHMgMSBmcm9tIHNjb3JlYm9hcmRcbmZ1bmN0aW9uIHVwZGF0ZVNjb3JlKCkge1xuICAkc2NvcmUuZW1wdHkoKTtcbiAgJHNjb3JlLmFwcGVuZChzY29yZSk7XG59XG5cblxuXG5mdW5jdGlvbiB3aGF0c1RoZUNvdW50KG51bSkge1xuICBpZiAobnVtIDwgNykge1xuICAgIGNvdW50ICs9IDE7XG4gIH0gZWxzZSBpZiAobnVtID4gOSkge1xuICAgIGNvdW50IC09IDE7XG4gIH1cbiAgJGNvdW50LmVtcHR5KCk7XG4gICRjb3VudC5hcHBlbmQoY291bnQpO1xuXG59XG5cblxuLy8gSlNPTiByZXF1ZXN0IGZ1bmN0aW9uIHdpdGggSlNPTlAgcHJveHlcbmZ1bmN0aW9uIGdldEpTT04odXJsLCBjYikge1xuICB2YXIgSlNPTlBfUFJPWFkgPSAnaHR0cHM6Ly9qc29ucC5hZmVsZC5tZS8/dXJsPSdcbiAgLy8gVEhJUyBXSUxMIEFERCBUSEUgQ1JPU1MgT1JJR0lOIEhFQURFUlNcbiAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgcmVxdWVzdC5vcGVuKCdHRVQnLCBKU09OUF9QUk9YWSArIHVybCk7XG4gIHJlcXVlc3Qub25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiByZXF1ZXN0LnN0YXR1cyA8IDQwMCkge1xuICAgICAgY2IoSlNPTi5wYXJzZShyZXF1ZXN0LnJlc3BvbnNlVGV4dCkpO1xuICAgIH1cbiAgfTtcbiAgcmVxdWVzdC5zZW5kKCk7XG59XG5cbi8vLy8vLy8vLy8vLy8vLy8vXG4vL3RoZSBncmF2ZXlhcmQvL1xuLy8vLy8vLy8vLy8vLy8vLy9cblxuLy8vL2Z1bmN0aW9uIGRyYXc0KCkge1xuICAvL2RyYXdEZWFsZXJDYXJkKGNhcmRCYWNrKTtcbiAgLy9kcmF3UGxheWVyQ2FyZCgpO1xuICAvL2RyYXdEZWFsZXJDYXJkKCk7XG4gIC8vZHJhd1BsYXllckNhcmQoKTtcbi8vfVxuXG4vL2Z1bmN0aW9uIGRyYXdEZWFsZXJDYXJkKGltYWdlKSB7XG4gIC8vdmFyIGNhcmRVUkwgPSBBUEkgKyBcImRyYXcvXCIgKyBkZWNrSWQgKyBcIi8/Y291bnQ9MVwiO1xuICAvL2dldEpTT04oY2FyZFVSTCwgZnVuY3Rpb24oZGF0YSkge1xuICAgIC8vaWYgKGltYWdlKSB7XG4gICAgICAvL3ZhciBodG1sID0gXCI8aW1nIGNsYXNzPSdjYXJkSW1hZ2UnIHNyYz0nXCIgKyBpbWFnZSArIFwiJz5cIjtcbiAgICAgIC8vJGRlYWxlci5hcHBlbmQoaHRtbCk7XG4gICAgLy99IGVsc2Uge1xuICAgICAgLy92YXIgaHRtbCA9IFwiPGltZyBjbGFzcz0nY2FyZEltYWdlJyBzcmM9J1wiICsgZGF0YS5jYXJkc1swXS5pbWFnZSArIFwiJz5cIjtcbiAgICAgIC8vJGRlYWxlci5hcHBlbmQoaHRtbCk7XG4gICAgLy99XG4gICAgLy9kZWFsZXJIYW5kLnB1c2goZGF0YS5jYXJkc1swXS52YWx1ZSk7XG4gICAgLy9jaGVja0RlYWxlclRvdGFsKCk7XG4gICAgLy9jaGVja1ZpY3RvcnkoKTtcbiAgLy99KTtcbi8vfVxuXG4vL2Z1bmN0aW9uIGRyYXdQbGF5ZXJDYXJkKCkge1xuICAvL3ZhciBjYXJkVVJMID0gQVBJICsgXCJkcmF3L1wiICsgZGVja0lkICsgXCIvP2NvdW50PTFcIjtcbiAgLy9nZXRKU09OKGNhcmRVUkwsIGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAvL3ZhciBodG1sID0gXCI8aW1nIGNsYXNzPSdjYXJkSW1hZ2UnIHNyYz0nXCIgKyBkYXRhLmNhcmRzWzBdLmltYWdlICsgXCInPlwiO1xuICAgIC8vJHBsYXllci5hcHBlbmQoaHRtbCk7XG4gICAgLy9wbGF5ZXJIYW5kLnB1c2goZGF0YS5jYXJkc1swXS52YWx1ZSk7XG4gICAgLy9jaGVja1BsYXllclRvdGFsKCk7XG4gICAgLy9jaGVja1ZpY3RvcnkoKTtcbiAgLy99KTtcbi8vfVxuXG4vLyBkZWFsIGEgbmV3IGhhbmQgZnJvbSBhIG5ldyBkZWNrXG4vL2Z1bmN0aW9uIGRlYWwoKSB7XG4gIC8vdmFyIHNodWZmbGVVUkwgPSBBUEkgKyBcInNodWZmbGUvP2RlY2tfY291bnQ9NlwiO1xuICAvL2NvdW50ID0gMDtcbiAgLy9yZXNldCgpO1xuICAvL2NvbnNvbGUubG9nKFwic2h1ZmZsZVVSTCA9IFwiICsgc2h1ZmZsZVVSTCk7XG4gIC8vZ2V0SlNPTihzaHVmZmxlVVJMLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgLy9kZWNrSWQgPSBkYXRhLmRlY2tfaWQ7XG4gICAgLy9jb25zb2xlLmxvZyhcImRlY2tJZCA9IFwiICsgZGVja0lkKTtcbiAgICAvL2RlYWxlckNhcmQoKTtcbiAgICAvL3BsYXllckNhcmQoKTtcbiAgICAvL2RlYWxlckNhcmQoKTtcbiAgICAvL3BsYXllckNhcmQoKTtcbiAgLy99KTtcbi8vfVxuXG4vLy8vIGRlYWwgYSBuZXcgaGFuZCBmcm9tIHRoZSBzYW1lIGRlY2tcbi8vZnVuY3Rpb24gc2FtZURlY2tEZWFsKCkge1xuICAgIC8vcmVzZXQoKTtcbiAgICAvL2RlYWxlckNhcmQoKTtcbiAgICAvL3BsYXllckNhcmQoKTtcbiAgICAvL2RlYWxlckNhcmQoKTtcbiAgICAvL3BsYXllckNhcmQoKTtcbi8vfVxuLy9cbi8vLy8gY2xlYXJzIGNhcmQgaW1hZ2VzIGFuZCByZXNldHMgZ2FtZSB2YWx1ZXMgdG8gaW5pdGlhbFxuLy9mdW5jdGlvbiByZXNldCgpIHtcbiAgLy8kZGVhbGVyLmVtcHR5KCk7XG4gIC8vJHBsYXllci5lbXB0eSgpO1xuICAvL2RlYWxlckhhbmRNYXggPSBbXTtcbiAgLy9wbGF5ZXJIYW5kTWF4ID0gW107XG4gIC8vZGVhbGVySGFuZE1pbiA9IFtdO1xuICAvL3BsYXllckhhbmRNaW4gPSBbXTtcbiAgLy9kZWFsZXJUb3RhbE1heCA9IDA7XG4gIC8vcGxheWVyVG90YWxNYXggPSAwO1xuICAvL2RlYWxlclRvdGFsTWluID0gMDtcbiAgLy9wbGF5ZXJUb3RhbE1pbiA9IDA7XG4gIC8vd2lubmVyID0gbnVsbDtcbiAgLy9jb25zb2xlLmxvZyhcIi0tcmVzZXQtLVwiKTtcbi8vfVxuIl19