"use strict";

var API = "http://deckofcardsapi.com/api/";
var newDeckURL = API + "shuffle/?deck_count=6";
var deckId;

var cardBack = "http://tinyurl.com/kqzzmbr";

//buttons
var $dealCards = $(".dealCards");
var $sameDeckDeal = $(".sameDeckDeal");
var $hit = $(".hit");
var $stay = $(".stay");
var $reset = $(".reset");

//scoreboard divs
var $score = $(".score");
var $count = $(".count");

//card hand divs
var $dealer = $(".dealer");
var $player = $(".player");

var dealerHand = [];
var playerHand = [];
var playerTotal = 0;
var dealerTotal = 0;

var dealerHandMax = [];
var playerHandMax = [];
var dealerHandMin = [];
var playerHandMin = [];
var dealerTotalMax;
var playerTotalMax;
var dealerTotalMin;
var playerTotalMin;
var winner;
var score = 0;
var count = 0;

$dealCards.click(deal);
//$sameDeckDeal.click(sameDeckDeal);
$hit.click(hit);
$stay.click(stay);
$reset.click(reset);

function deal() {
  if (!deckId) {
    getJSON(newDeckURL, function (data) {
      deckId = data.deck_id;
      console.log("About to deal from new deck");
      draw4();
    });
  } else {
    console.log("About to deal from current deck");
    draw4();
  }
}

function draw4() {
  drawCard("dealer", cardBack);
  drawCard("player");
  drawCard("dealer");
  drawCard("player");
  checkDealerTotal();
  checkPlayerTotal();
}

function drawCard(person, image) {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data) {
    if (image) {
      var html = "<img class='cardImage' src='" + image + "'>";
      $("." + person).append(html);
    } else {
      var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
      $("." + person).append(html);
    }
    if (person === "dealer") {
      dealerHand.push(data.cards[0].value);
    } else if (person === "player") {
      playerHand.push(data.cards[0].value);
    }
  });
}

function checkPlayerTotal() {
  playerHand.forEach(function (card) {
    if (card === "KING" || card === "QUEEN" || card === "JACK" || card === "10") {
      playerTotal += 10;
    } else if (!isNaN(card)) {
      playerTotal += Number(card);
    } else if (card === "ACE") {
      if (playerTotal <= 10) {
        playerTotal += 11;
      } else {
        playerTotal += 1;
      }
    }
  });
}

function checkDealerTotal() {
  dealerHand.forEach(function (card) {
    if (card === "KING" || card === "QUEEN" || card === "JACK" || card === "10") {
      dealerTotal += 10;
    } else if (!isNaN(card)) {
      dealerTotal += Number(card);
    } else if (card === "ACE") {
      if (dealerTotal <= 10) {
        dealerTotal += 11;
      } else {
        dealerTotal += 1;
      }
    }
  });
}

function checkVictory() {
  if (dealerTotal === 21) {
    console.log("dealer has 21");
    winner = "dealer";
    score -= 1;
  } else if (dealerTotal > 21) {
    console.log("dealer busts");
    winner = "player";
    score += 1;
  }

  if (playerTotal === 21) {
    console.log("player has 21");
    winner = "player";
    score += 1;
  } else if (playerTotal > 21) {
    console.log("player busts");
    winner = "dealer";
    score -= 1;
  }

  if (winner) {
    updateScore();
    clearTable();
  }
}

function clearTable() {
  $dealer.empty();
  $player.empty();
  dealerHand = [];
  playerHand = [];
  dealerTotal = 0;
  playerTotal = 0;
  winner = null;
  console.log("--table cleared--");
}

// deal a new hand from a new deck
//function deal() {
//var shuffleURL = API + "shuffle/?deck_count=6";
//count = 0;
//reset();
//console.log("shuffleURL = " + shuffleURL);
//getJSON(shuffleURL, function(data) {
//deckId = data.deck_id;
//console.log("deckId = " + deckId);
//dealerCard();
//playerCard();
//dealerCard();
//playerCard();
//});
//}

//// deal a new hand from the same deck
//function sameDeckDeal() {
//reset();
//dealerCard();
//playerCard();
//dealerCard();
//playerCard();
//}

function hit() {
  console.log("hit");
  debugger;
  playerCard();
  if (!winner && dealerTotalMin < 17) {
    dealerCard();
  } else {
    if (dealerTotalMax < 22) {
      console.log("dealer stays at " + dealerTotalMax);
    } else {
      console.log("dealer stays at " + dealerTotalMin);
    }
  }
}

function stay() {
  console.log("stay");
  var dealerTotalFinal = dealerTotalMax < 22 ? dealerTotalMax : dealerTotalMin;
  var playerTotalFinal = playerTotalMax < 22 ? playerTotalMax : playerTotalMin;

  if (dealerTotalMin < 17) {
    dealerCard();
  } else {
    dealerTotalFinal >= playerTotalFinal ? (winner = "dealer", score -= 1, console.log("dealer's " + dealerTotalFinal + " beats player's " + playerTotalFinal)) : (winner = "player", score += 1, console.log("player's " + playerTotalFinal + " beats dealer's " + dealerTotalFinal));
    checkGame();
  }
}

// deal dealer one card
function dealerCard() {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data) {
    var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
    $dealer.append(html);

    dealerHandMax.push(convertCardMax(data.cards[0].value));
    dealerTotalMax = getTotal(dealerHandMax);
    dealerHandMin.push(convertCardMin(data.cards[0].value));
    dealerTotalMin = getTotal(dealerHandMin);

    if (dealerTotalMin === dealerTotalMax) {
      console.log("dealer's hand - " + dealerHandMax + " **** dealer is at " + dealerTotalMax);
    } else {
      console.log("dealer's hand - " + dealerHandMax + " or " + dealerHandMin + " **** dealer is at " + dealerTotalMax + " or " + dealerTotalMin);
    }

    whatsTheCount(convertCardMax(data.cards[0].value));
    checkGame();
  });
}

// deal player one card
function playerCard() {
  var cardURL = API + "draw/" + deckId + "/?count=1";
  getJSON(cardURL, function (data) {
    var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
    $player.append(html);

    playerHandMax.push(convertCardMax(data.cards[0].value));
    playerTotalMax = getTotal(playerHandMax);
    playerHandMin.push(convertCardMin(data.cards[0].value));
    playerTotalMin = getTotal(playerHandMin);

    if (playerTotalMin === playerTotalMax) {
      console.log("player's hand - " + playerHandMax + " **** player is at " + playerTotalMax);
    } else {
      console.log("player's hand - " + playerHandMax + " or " + playerHandMin + " **** player is at " + playerTotalMax + " or " + playerTotalMin);
    }

    whatsTheCount(convertCardMax(data.cards[0].value));
    checkGame();
  });
}

// converts JSON string values in card hard arrays to numbers
function convertCardMax(value) {
  if (value === "ACE") {
    return 11;
  } else if (isNaN(value)) {
    return 10;
  } else {
    return Number(value);
  }
}

function convertCardMin(value) {
  if (value === "ACE") {
    return 1;
  } else if (isNaN(value)) {
    return 10;
  } else {
    return Number(value);
  }
}

// reduces card hand arrays to totals
function getTotal(hand) {
  var total = hand.reduce(function (prev, curr) {
    return prev + curr;
  });
  return total;
}

// looks for victory conditions and triggers game reset and scorekeeping
function checkGame() {
  if (dealerTotalMax === 21 || dealerTotalMin === 21) {
    console.log("dealer has 21");
    winner = "dealer";
    score -= 1;
  } else if (dealerTotalMin > 21) {
    console.log("dealer busts");
    winner = "player";
    score += 1;
  }

  if (playerTotalMax === 21 || playerTotalMin === 21) {
    console.log("player has 21");
    winner = "player";
    score += 1;
  } else if (playerTotalMin > 21) {
    console.log("player busts");
    winner = "dealer";
    score -= 1;
  }

  if (winner) {
    updateScore();
    reset();
  }
}

// adds 1 or subtracts 1 from scoreboard
function updateScore() {
  $score.empty();
  $score.append(score);
}

// clears card images and resets game values to initial
function reset() {
  $dealer.empty();
  $player.empty();
  dealerHandMax = [];
  playerHandMax = [];
  dealerHandMin = [];
  playerHandMin = [];
  dealerTotalMax = 0;
  playerTotalMax = 0;
  dealerTotalMin = 0;
  playerTotalMin = 0;
  winner = null;
  console.log("--reset--");
}

function whatsTheCount(num) {
  if (num < 7) {
    count += 1;
  } else if (num > 9) {
    count -= 1;
  }
  $count.empty();
  $count.append(count);
}

// JSON request function with JSONP proxy
function getJSON(url, cb) {
  var JSONP_PROXY = "https://jsonp.afeld.me/?url=";
  // THIS WILL ADD THE CROSS ORIGIN HEADERS
  var request = new XMLHttpRequest();
  request.open("GET", JSONP_PROXY + url);
  request.onload = function () {
    if (request.status >= 200 && request.status < 400) {
      cb(JSON.parse(request.responseText));
    }
  };
  request.send();
}
//# sourceMappingURL=data:application/json;base64,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LENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztLQUN0QztHQUNGLENBQUM7QUFDRixTQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7Q0FDaEIiLCJmaWxlIjoic3JjL21haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgQVBJID0gXCJodHRwOi8vZGVja29mY2FyZHNhcGkuY29tL2FwaS9cIjtcbnZhciBuZXdEZWNrVVJMID0gQVBJICsgXCJzaHVmZmxlLz9kZWNrX2NvdW50PTZcIjtcbnZhciBkZWNrSWQ7XG5cbnZhciBjYXJkQmFjayA9IFwiaHR0cDovL3Rpbnl1cmwuY29tL2txenptYnJcIjtcblxuLy9idXR0b25zXG52YXIgJGRlYWxDYXJkcyA9ICQoXCIuZGVhbENhcmRzXCIpO1xudmFyICRzYW1lRGVja0RlYWwgPSAkKFwiLnNhbWVEZWNrRGVhbFwiKTtcbnZhciAkaGl0ID0gJChcIi5oaXRcIik7XG52YXIgJHN0YXkgPSAkKFwiLnN0YXlcIik7XG52YXIgJHJlc2V0ID0gJChcIi5yZXNldFwiKTtcblxuLy9zY29yZWJvYXJkIGRpdnNcbnZhciAkc2NvcmUgPSAkKFwiLnNjb3JlXCIpO1xudmFyICRjb3VudCA9ICQoXCIuY291bnRcIik7XG5cbi8vY2FyZCBoYW5kIGRpdnNcbnZhciAkZGVhbGVyID0gJChcIi5kZWFsZXJcIik7XG52YXIgJHBsYXllciA9ICQoXCIucGxheWVyXCIpO1xuXG52YXIgZGVhbGVySGFuZCA9IFtdO1xudmFyIHBsYXllckhhbmQgPSBbXTtcbnZhciBwbGF5ZXJUb3RhbCA9IDA7XG52YXIgZGVhbGVyVG90YWwgPSAwO1xuXG52YXIgZGVhbGVySGFuZE1heCA9IFtdO1xudmFyIHBsYXllckhhbmRNYXggPSBbXTtcbnZhciBkZWFsZXJIYW5kTWluID0gW107XG52YXIgcGxheWVySGFuZE1pbiA9IFtdO1xudmFyIGRlYWxlclRvdGFsTWF4O1xudmFyIHBsYXllclRvdGFsTWF4O1xudmFyIGRlYWxlclRvdGFsTWluO1xudmFyIHBsYXllclRvdGFsTWluO1xudmFyIHdpbm5lcjtcbnZhciBzY29yZSA9IDA7XG52YXIgY291bnQgPSAwO1xuXG4kZGVhbENhcmRzLmNsaWNrKGRlYWwpO1xuLy8kc2FtZURlY2tEZWFsLmNsaWNrKHNhbWVEZWNrRGVhbCk7XG4kaGl0LmNsaWNrKGhpdCk7XG4kc3RheS5jbGljayhzdGF5KTtcbiRyZXNldC5jbGljayhyZXNldCk7XG5cbmZ1bmN0aW9uIGRlYWwoKSB7XG4gIGlmICghZGVja0lkKSB7XG4gICAgZ2V0SlNPTihuZXdEZWNrVVJMLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICBkZWNrSWQgPSBkYXRhLmRlY2tfaWQ7XG4gICAgICBjb25zb2xlLmxvZyhcIkFib3V0IHRvIGRlYWwgZnJvbSBuZXcgZGVja1wiKTtcbiAgICAgIGRyYXc0KCk7XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgY29uc29sZS5sb2coXCJBYm91dCB0byBkZWFsIGZyb20gY3VycmVudCBkZWNrXCIpO1xuICAgIGRyYXc0KCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZHJhdzQoKSB7XG4gIGRyYXdDYXJkKFwiZGVhbGVyXCIsIGNhcmRCYWNrKTtcbiAgZHJhd0NhcmQoXCJwbGF5ZXJcIik7XG4gIGRyYXdDYXJkKFwiZGVhbGVyXCIpO1xuICBkcmF3Q2FyZChcInBsYXllclwiKTtcbiAgY2hlY2tEZWFsZXJUb3RhbCgpO1xuICBjaGVja1BsYXllclRvdGFsKCk7XG5cbn1cblxuZnVuY3Rpb24gZHJhd0NhcmQocGVyc29uLCBpbWFnZSkge1xuICB2YXIgY2FyZFVSTCA9IEFQSSArIFwiZHJhdy9cIiArIGRlY2tJZCArIFwiLz9jb3VudD0xXCI7XG4gIGdldEpTT04oY2FyZFVSTCwgZnVuY3Rpb24oZGF0YSkge1xuICAgIGlmIChpbWFnZSkge1xuICAgICAgdmFyIGh0bWwgPSBcIjxpbWcgY2xhc3M9J2NhcmRJbWFnZScgc3JjPSdcIiArIGltYWdlICsgXCInPlwiO1xuICAgICAgJChcIi5cIiArIHBlcnNvbikuYXBwZW5kKGh0bWwpO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgaHRtbCA9IFwiPGltZyBjbGFzcz0nY2FyZEltYWdlJyBzcmM9J1wiICsgZGF0YS5jYXJkc1swXS5pbWFnZSArIFwiJz5cIjtcbiAgICAgICQoXCIuXCIgKyBwZXJzb24pLmFwcGVuZChodG1sKTtcbiAgICB9XG4gICAgaWYgKHBlcnNvbiA9PT0gXCJkZWFsZXJcIikge1xuICAgICAgZGVhbGVySGFuZC5wdXNoKGRhdGEuY2FyZHNbMF0udmFsdWUpO1xuICAgIH0gZWxzZSBpZiAocGVyc29uID09PSBcInBsYXllclwiKSB7XG4gICAgICBwbGF5ZXJIYW5kLnB1c2goZGF0YS5jYXJkc1swXS52YWx1ZSk7XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gY2hlY2tQbGF5ZXJUb3RhbCgpIHtcbiAgcGxheWVySGFuZC5mb3JFYWNoKGZ1bmN0aW9uKGNhcmQpIHtcbiAgICBpZiAoY2FyZCA9PT0gXCJLSU5HXCIgfHwgY2FyZCA9PT0gXCJRVUVFTlwiIHx8IGNhcmQgPT09IFwiSkFDS1wiIHx8IGNhcmQgPT09IFwiMTBcIikge1xuICAgICAgcGxheWVyVG90YWwgKz0gMTA7XG4gICAgfSBlbHNlIGlmICghaXNOYU4oY2FyZCkpIHtcbiAgICAgIHBsYXllclRvdGFsICs9IE51bWJlcihjYXJkKTtcbiAgICB9IGVsc2UgaWYgKGNhcmQgPT09IFwiQUNFXCIpIHtcbiAgICAgIGlmIChwbGF5ZXJUb3RhbCA8PSAxMCkge1xuICAgICAgICBwbGF5ZXJUb3RhbCArPSAxMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHBsYXllclRvdGFsICs9IDE7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gY2hlY2tEZWFsZXJUb3RhbCgpIHtcbiAgZGVhbGVySGFuZC5mb3JFYWNoKGZ1bmN0aW9uKGNhcmQpIHtcbiAgICBpZiAoY2FyZCA9PT0gXCJLSU5HXCIgfHwgY2FyZCA9PT0gXCJRVUVFTlwiIHx8IGNhcmQgPT09IFwiSkFDS1wiIHx8IGNhcmQgPT09IFwiMTBcIikge1xuICAgICAgZGVhbGVyVG90YWwgKz0gMTA7XG4gICAgfSBlbHNlIGlmICghaXNOYU4oY2FyZCkpIHtcbiAgICAgIGRlYWxlclRvdGFsICs9IE51bWJlcihjYXJkKTtcbiAgICB9IGVsc2UgaWYgKGNhcmQgPT09IFwiQUNFXCIpIHtcbiAgICAgIGlmIChkZWFsZXJUb3RhbCA8PSAxMCkge1xuICAgICAgICBkZWFsZXJUb3RhbCArPSAxMTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGRlYWxlclRvdGFsICs9IDE7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gY2hlY2tWaWN0b3J5KCkge1xuICBpZiAoZGVhbGVyVG90YWwgPT09IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJkZWFsZXIgaGFzIDIxXCIpO1xuICAgIHdpbm5lciA9IFwiZGVhbGVyXCI7XG4gICAgc2NvcmUgLT0gMTtcbiAgfSBlbHNlIGlmIChkZWFsZXJUb3RhbCA+IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJkZWFsZXIgYnVzdHNcIik7XG4gICAgd2lubmVyID0gXCJwbGF5ZXJcIjtcbiAgICBzY29yZSArPSAxO1xuICB9XG5cbiAgaWYgKHBsYXllclRvdGFsID09PSAyMSkge1xuICAgIGNvbnNvbGUubG9nKFwicGxheWVyIGhhcyAyMVwiKTtcbiAgICB3aW5uZXIgPSBcInBsYXllclwiO1xuICAgIHNjb3JlICs9IDE7XG4gIH0gZWxzZSBpZiAocGxheWVyVG90YWwgPiAyMSkge1xuICAgIGNvbnNvbGUubG9nKFwicGxheWVyIGJ1c3RzXCIpO1xuICAgIHdpbm5lciA9IFwiZGVhbGVyXCI7XG4gICAgc2NvcmUgLT0gMTtcbiAgfVxuXG4gIGlmICh3aW5uZXIpIHtcbiAgICB1cGRhdGVTY29yZSgpO1xuICAgIGNsZWFyVGFibGUoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBjbGVhclRhYmxlKCkge1xuICAkZGVhbGVyLmVtcHR5KCk7XG4gICRwbGF5ZXIuZW1wdHkoKTtcbiAgZGVhbGVySGFuZCA9IFtdO1xuICBwbGF5ZXJIYW5kID0gW107XG4gIGRlYWxlclRvdGFsID0gMDtcbiAgcGxheWVyVG90YWwgPSAwO1xuICB3aW5uZXIgPSBudWxsO1xuICBjb25zb2xlLmxvZyhcIi0tdGFibGUgY2xlYXJlZC0tXCIpO1xufVxuXG5cblxuLy8gZGVhbCBhIG5ldyBoYW5kIGZyb20gYSBuZXcgZGVja1xuLy9mdW5jdGlvbiBkZWFsKCkge1xuICAvL3ZhciBzaHVmZmxlVVJMID0gQVBJICsgXCJzaHVmZmxlLz9kZWNrX2NvdW50PTZcIjtcbiAgLy9jb3VudCA9IDA7XG4gIC8vcmVzZXQoKTtcbiAgLy9jb25zb2xlLmxvZyhcInNodWZmbGVVUkwgPSBcIiArIHNodWZmbGVVUkwpO1xuICAvL2dldEpTT04oc2h1ZmZsZVVSTCwgZnVuY3Rpb24oZGF0YSkge1xuICAgIC8vZGVja0lkID0gZGF0YS5kZWNrX2lkO1xuICAgIC8vY29uc29sZS5sb2coXCJkZWNrSWQgPSBcIiArIGRlY2tJZCk7XG4gICAgLy9kZWFsZXJDYXJkKCk7XG4gICAgLy9wbGF5ZXJDYXJkKCk7XG4gICAgLy9kZWFsZXJDYXJkKCk7XG4gICAgLy9wbGF5ZXJDYXJkKCk7XG4gIC8vfSk7XG4vL31cblxuLy8vLyBkZWFsIGEgbmV3IGhhbmQgZnJvbSB0aGUgc2FtZSBkZWNrXG4vL2Z1bmN0aW9uIHNhbWVEZWNrRGVhbCgpIHtcbiAgICAvL3Jlc2V0KCk7XG4gICAgLy9kZWFsZXJDYXJkKCk7XG4gICAgLy9wbGF5ZXJDYXJkKCk7XG4gICAgLy9kZWFsZXJDYXJkKCk7XG4gICAgLy9wbGF5ZXJDYXJkKCk7XG4vL31cblxuZnVuY3Rpb24gaGl0KCkge1xuICBjb25zb2xlLmxvZyhcImhpdFwiKTtcbiAgZGVidWdnZXI7XG4gIHBsYXllckNhcmQoKTtcbiAgaWYgKCF3aW5uZXIgJiYgZGVhbGVyVG90YWxNaW4gPCAxNykge1xuICAgIGRlYWxlckNhcmQoKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoZGVhbGVyVG90YWxNYXggPCAyMikge1xuICAgICAgY29uc29sZS5sb2coXCJkZWFsZXIgc3RheXMgYXQgXCIgKyBkZWFsZXJUb3RhbE1heCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyIHN0YXlzIGF0IFwiICsgZGVhbGVyVG90YWxNaW4pO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBzdGF5KCkge1xuICBjb25zb2xlLmxvZyhcInN0YXlcIik7XG4gIHZhciBkZWFsZXJUb3RhbEZpbmFsID0gKGRlYWxlclRvdGFsTWF4IDwgMjIpID8gZGVhbGVyVG90YWxNYXggOiBkZWFsZXJUb3RhbE1pbjtcbiAgdmFyIHBsYXllclRvdGFsRmluYWwgPSAocGxheWVyVG90YWxNYXggPCAyMikgPyBwbGF5ZXJUb3RhbE1heCA6IHBsYXllclRvdGFsTWluO1xuXG4gIGlmIChkZWFsZXJUb3RhbE1pbiA8IDE3KSB7XG4gICAgZGVhbGVyQ2FyZCgpO1xuICB9IGVsc2Uge1xuICAgIGRlYWxlclRvdGFsRmluYWwgPj0gcGxheWVyVG90YWxGaW5hbCA/XG4gICAgICAod2lubmVyID0gXCJkZWFsZXJcIiwgc2NvcmUgLT0gMSwgY29uc29sZS5sb2coXCJkZWFsZXIncyBcIiArIGRlYWxlclRvdGFsRmluYWwgKyBcIiBiZWF0cyBwbGF5ZXIncyBcIiArIHBsYXllclRvdGFsRmluYWwpKSA6XG4gICAgICAod2lubmVyID0gXCJwbGF5ZXJcIiwgc2NvcmUgKz0gMSwgY29uc29sZS5sb2coXCJwbGF5ZXIncyBcIiArIHBsYXllclRvdGFsRmluYWwgKyBcIiBiZWF0cyBkZWFsZXIncyBcIiArIGRlYWxlclRvdGFsRmluYWwpKTtcbiAgICBjaGVja0dhbWUoKTtcbiAgfVxufVxuXG4vLyBkZWFsIGRlYWxlciBvbmUgY2FyZFxuZnVuY3Rpb24gZGVhbGVyQ2FyZCgpe1xuICB2YXIgY2FyZFVSTCA9IEFQSSArIFwiZHJhdy9cIiArIGRlY2tJZCArIFwiLz9jb3VudD0xXCI7XG4gIGdldEpTT04oY2FyZFVSTCwgZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBodG1sID0gXCI8aW1nIGNsYXNzPSdjYXJkSW1hZ2UnIHNyYz0nXCIgKyBkYXRhLmNhcmRzWzBdLmltYWdlICsgXCInPlwiO1xuICAgICRkZWFsZXIuYXBwZW5kKGh0bWwpO1xuXG4gICAgZGVhbGVySGFuZE1heC5wdXNoKGNvbnZlcnRDYXJkTWF4KGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBkZWFsZXJUb3RhbE1heCA9IGdldFRvdGFsKGRlYWxlckhhbmRNYXgpO1xuICAgIGRlYWxlckhhbmRNaW4ucHVzaChjb252ZXJ0Q2FyZE1pbihkYXRhLmNhcmRzWzBdLnZhbHVlKSk7XG4gICAgZGVhbGVyVG90YWxNaW4gPSBnZXRUb3RhbChkZWFsZXJIYW5kTWluKTtcblxuICAgIGlmIChkZWFsZXJUb3RhbE1pbiA9PT0gZGVhbGVyVG90YWxNYXgpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyJ3MgaGFuZCAtIFwiICsgZGVhbGVySGFuZE1heCArIFwiICoqKiogZGVhbGVyIGlzIGF0IFwiICsgZGVhbGVyVG90YWxNYXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhcImRlYWxlcidzIGhhbmQgLSBcIiArIGRlYWxlckhhbmRNYXggKyBcIiBvciBcIiArIGRlYWxlckhhbmRNaW4gKyBcIiAqKioqIGRlYWxlciBpcyBhdCBcIiArIGRlYWxlclRvdGFsTWF4ICsgXCIgb3IgXCIgKyBkZWFsZXJUb3RhbE1pbik7XG4gICAgfVxuXG4gICAgd2hhdHNUaGVDb3VudChjb252ZXJ0Q2FyZE1heChkYXRhLmNhcmRzWzBdLnZhbHVlKSk7XG4gICAgY2hlY2tHYW1lKCk7XG4gIH0pO1xufVxuXG4vLyBkZWFsIHBsYXllciBvbmUgY2FyZFxuZnVuY3Rpb24gcGxheWVyQ2FyZCgpe1xuICB2YXIgY2FyZFVSTCA9IEFQSSArIFwiZHJhdy9cIiArIGRlY2tJZCArIFwiLz9jb3VudD0xXCI7XG4gIGdldEpTT04oY2FyZFVSTCwgZnVuY3Rpb24oZGF0YSkge1xuICAgIHZhciBodG1sID0gXCI8aW1nIGNsYXNzPSdjYXJkSW1hZ2UnIHNyYz0nXCIgKyBkYXRhLmNhcmRzWzBdLmltYWdlICsgXCInPlwiO1xuICAgICRwbGF5ZXIuYXBwZW5kKGh0bWwpO1xuXG4gICAgcGxheWVySGFuZE1heC5wdXNoKGNvbnZlcnRDYXJkTWF4KGRhdGEuY2FyZHNbMF0udmFsdWUpKTtcbiAgICBwbGF5ZXJUb3RhbE1heCA9IGdldFRvdGFsKHBsYXllckhhbmRNYXgpO1xuICAgIHBsYXllckhhbmRNaW4ucHVzaChjb252ZXJ0Q2FyZE1pbihkYXRhLmNhcmRzWzBdLnZhbHVlKSk7XG4gICAgcGxheWVyVG90YWxNaW4gPSBnZXRUb3RhbChwbGF5ZXJIYW5kTWluKTtcblxuICAgIGlmIChwbGF5ZXJUb3RhbE1pbiA9PT0gcGxheWVyVG90YWxNYXgpIHtcbiAgICAgIGNvbnNvbGUubG9nKFwicGxheWVyJ3MgaGFuZCAtIFwiICsgcGxheWVySGFuZE1heCArIFwiICoqKiogcGxheWVyIGlzIGF0IFwiICsgcGxheWVyVG90YWxNYXgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhcInBsYXllcidzIGhhbmQgLSBcIiArIHBsYXllckhhbmRNYXggKyBcIiBvciBcIiArIHBsYXllckhhbmRNaW4gKyBcIiAqKioqIHBsYXllciBpcyBhdCBcIiArIHBsYXllclRvdGFsTWF4ICsgXCIgb3IgXCIgKyBwbGF5ZXJUb3RhbE1pbik7XG4gICAgfVxuXG4gICAgd2hhdHNUaGVDb3VudChjb252ZXJ0Q2FyZE1heChkYXRhLmNhcmRzWzBdLnZhbHVlKSk7XG4gICAgY2hlY2tHYW1lKCk7XG4gIH0pO1xufVxuXG4vLyBjb252ZXJ0cyBKU09OIHN0cmluZyB2YWx1ZXMgaW4gY2FyZCBoYXJkIGFycmF5cyB0byBudW1iZXJzXG5mdW5jdGlvbiBjb252ZXJ0Q2FyZE1heCh2YWx1ZSkge1xuICBpZiAodmFsdWUgPT09IFwiQUNFXCIpIHtcbiAgICByZXR1cm4gMTE7XG4gIH0gZWxzZSBpZiAoaXNOYU4odmFsdWUpKSB7XG4gICAgcmV0dXJuIDEwO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBOdW1iZXIodmFsdWUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbnZlcnRDYXJkTWluKHZhbHVlKSB7XG4gIGlmICh2YWx1ZSA9PT0gXCJBQ0VcIikge1xuICAgIHJldHVybiAxO1xuICB9IGVsc2UgaWYgKGlzTmFOKHZhbHVlKSkge1xuICAgIHJldHVybiAxMDtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gTnVtYmVyKHZhbHVlKTtcbiAgfVxufVxuXG4vLyByZWR1Y2VzIGNhcmQgaGFuZCBhcnJheXMgdG8gdG90YWxzXG5mdW5jdGlvbiBnZXRUb3RhbChoYW5kKSB7XG4gIHZhciB0b3RhbCA9IGhhbmQucmVkdWNlKGZ1bmN0aW9uKHByZXYsIGN1cnIpIHtcbiAgICByZXR1cm4gcHJldiArIGN1cnI7XG4gIH0pO1xuICByZXR1cm4gdG90YWw7XG59XG5cbi8vIGxvb2tzIGZvciB2aWN0b3J5IGNvbmRpdGlvbnMgYW5kIHRyaWdnZXJzIGdhbWUgcmVzZXQgYW5kIHNjb3Jla2VlcGluZ1xuZnVuY3Rpb24gY2hlY2tHYW1lKCkge1xuICBpZiAoZGVhbGVyVG90YWxNYXggPT09IDIxIHx8IGRlYWxlclRvdGFsTWluID09PSAyMSkge1xuICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyIGhhcyAyMVwiKTtcbiAgICB3aW5uZXIgPSBcImRlYWxlclwiO1xuICAgIHNjb3JlIC09IDE7XG4gIH0gZWxzZSBpZiAoZGVhbGVyVG90YWxNaW4gPiAyMSkge1xuICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyIGJ1c3RzXCIpO1xuICAgIHdpbm5lciA9IFwicGxheWVyXCI7XG4gICAgc2NvcmUgKz0gMTtcbiAgfVxuXG4gIGlmIChwbGF5ZXJUb3RhbE1heCA9PT0gMjEgfHwgcGxheWVyVG90YWxNaW4gPT09IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJwbGF5ZXIgaGFzIDIxXCIpO1xuICAgIHdpbm5lciA9IFwicGxheWVyXCI7XG4gICAgc2NvcmUgKz0gMTtcbiAgfSBlbHNlIGlmIChwbGF5ZXJUb3RhbE1pbiA+IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJwbGF5ZXIgYnVzdHNcIik7XG4gICAgd2lubmVyID0gXCJkZWFsZXJcIjtcbiAgICBzY29yZSAtPSAxO1xuICB9XG5cbiAgaWYgKHdpbm5lcikge1xuICAgIHVwZGF0ZVNjb3JlKCk7XG4gICAgcmVzZXQoKTtcbiAgfVxufVxuXG4vLyBhZGRzIDEgb3Igc3VidHJhY3RzIDEgZnJvbSBzY29yZWJvYXJkXG5mdW5jdGlvbiB1cGRhdGVTY29yZSgpIHtcbiAgJHNjb3JlLmVtcHR5KCk7XG4gICRzY29yZS5hcHBlbmQoc2NvcmUpO1xufVxuXG4vLyBjbGVhcnMgY2FyZCBpbWFnZXMgYW5kIHJlc2V0cyBnYW1lIHZhbHVlcyB0byBpbml0aWFsXG5mdW5jdGlvbiByZXNldCgpIHtcbiAgJGRlYWxlci5lbXB0eSgpO1xuICAkcGxheWVyLmVtcHR5KCk7XG4gIGRlYWxlckhhbmRNYXggPSBbXTtcbiAgcGxheWVySGFuZE1heCA9IFtdO1xuICBkZWFsZXJIYW5kTWluID0gW107XG4gIHBsYXllckhhbmRNaW4gPSBbXTtcbiAgZGVhbGVyVG90YWxNYXggPSAwO1xuICBwbGF5ZXJUb3RhbE1heCA9IDA7XG4gIGRlYWxlclRvdGFsTWluID0gMDtcbiAgcGxheWVyVG90YWxNaW4gPSAwO1xuICB3aW5uZXIgPSBudWxsO1xuICBjb25zb2xlLmxvZyhcIi0tcmVzZXQtLVwiKTtcbn1cblxuZnVuY3Rpb24gd2hhdHNUaGVDb3VudChudW0pIHtcbiAgaWYgKG51bSA8IDcpIHtcbiAgICBjb3VudCArPSAxO1xuICB9IGVsc2UgaWYgKG51bSA+IDkpIHtcbiAgICBjb3VudCAtPSAxO1xuICB9XG4gICRjb3VudC5lbXB0eSgpO1xuICAkY291bnQuYXBwZW5kKGNvdW50KTtcblxufVxuXG5cbi8vIEpTT04gcmVxdWVzdCBmdW5jdGlvbiB3aXRoIEpTT05QIHByb3h5XG5mdW5jdGlvbiBnZXRKU09OKHVybCwgY2IpIHtcbiAgdmFyIEpTT05QX1BST1hZID0gJ2h0dHBzOi8vanNvbnAuYWZlbGQubWUvP3VybD0nXG4gIC8vIFRISVMgV0lMTCBBREQgVEhFIENST1NTIE9SSUdJTiBIRUFERVJTXG4gIHZhciByZXF1ZXN0ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gIHJlcXVlc3Qub3BlbignR0VUJywgSlNPTlBfUFJPWFkgKyB1cmwpO1xuICByZXF1ZXN0Lm9ubG9hZCA9IGZ1bmN0aW9uKCkge1xuICAgIGlmIChyZXF1ZXN0LnN0YXR1cyA+PSAyMDAgJiYgcmVxdWVzdC5zdGF0dXMgPCA0MDApIHtcbiAgICAgIGNiKEpTT04ucGFyc2UocmVxdWVzdC5yZXNwb25zZVRleHQpKTtcbiAgICB9XG4gIH07XG4gIHJlcXVlc3Quc2VuZCgpO1xufVxuIl19