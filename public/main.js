"use strict";

var API = "http://deckofcardsapi.com/api/";
var newDeckURL = API + "shuffle/?deck_count=6";
var game;

var cardBack = "http://tinyurl.com/kqzzmbr";

//buttons
var $newGame = $(".newGame");
var $deal = $(".deal");
var $hit = $(".hit");
var $stay = $(".stay");

//scoreboard divs
var $score = $(".score");
var $count = $(".count");

//card hand divs
var $dealer = $(".dealer");
var $player = $(".player");

var score = 0;

$newGame.click(newGame);
$deal.click(deal);
$hit.click(hit);
$stay.click(stay);

function Game() {
  this.deckId = "";
  this.hiddenCard = "";
  this.dealerHand = [];
  this.playerHand = [];
  this.dealerTotal = 0;
  this.playerTotal = 0;
  this.winner = "";
  this.count = 0;
}

function newGame() {
  score = 0;
  game = new Game();
  deal();
}

function deal() {
  clearTable();
  $hit.attr("disabled", false);
  $stay.attr("disabled", false);

  if (game.deckId === "") {
    getJSON(newDeckURL, function (data) {
      game.deckId = data.deck_id;
      console.log("About to deal from new deck");
      draw4();
    });
  } else {
    console.log("About to deal from current deck");
    draw4();
  }
}

function draw4() {
  drawCard("dealer", cardBack);
  drawCard("player");
  drawCard("dealer");
  drawCard("player");
}

function drawCard(person, image) {
  var cardURL = API + "draw/" + game.deckId + "/?count=1";
  getJSON(cardURL, function (data, cb) {
    if (image) {
      var html = "<img class='cardImage' src='" + image + "'>";
      $("." + person).append(html);
      game.hiddenCard = data.cards[0].image;
    } else {
      var html = "<img class='cardImage' src='" + data.cards[0].image + "'>";
      $("." + person).append(html);
    }
    if (person === "dealer") {
      game.dealerHand.push(data.cards[0].value);
      checkDealerTotal();
      console.log("dealer's hand - " + game.dealerHand + " **** dealer is at " + game.dealerTotal);
    } else if (person === "player") {
      game.playerHand.push(data.cards[0].value);
      checkPlayerTotal();
      console.log("player's hand - " + game.playerHand + " **** player is at " + game.playerTotal);
    }
    checkVictory();
    updateCount(data.cards[0].value);
  });
}

function checkPlayerTotal() {
  game.playerTotal = 0;
  game.playerHand.forEach(function (card) {
    if (card === "KING" || card === "QUEEN" || card === "JACK") {
      game.playerTotal += 10;
    } else if (!isNaN(card)) {
      game.playerTotal += Number(card);
    }
  });
  game.playerHand.forEach(function (card) {
    if (card === "ACE") {
      if (game.playerTotal <= 10) {
        game.playerTotal += 11;
      } else {
        game.playerTotal += 1;
      }
    }
  });
}

function checkDealerTotal() {
  game.dealerTotal = 0;
  game.dealerHand.forEach(function (card) {
    if (card === "KING" || card === "QUEEN" || card === "JACK") {
      game.dealerTotal += 10;
    } else if (!isNaN(card)) {
      game.dealerTotal += Number(card);
    }
  });
  game.dealerHand.forEach(function (card) {
    if (card === "ACE") {
      if (game.dealerTotal <= 10) {
        game.dealerTotal += 11;
      } else {
        game.dealerTotal += 1;
      }
    }
  });
}

function checkVictory() {
  if (game.dealerTotal === 21) {
    console.log("dealer has 21");
    game.winner = "dealer";
    score -= 1;
  } else if (game.dealerTotal > 21) {
    console.log("dealer busts");
    game.winner = "player";
    score += 1;
  }

  if (game.playerTotal === 21) {
    console.log("player has 21");
    game.winner = "player";
    score += 1;
  } else if (game.playerTotal > 21) {
    console.log("player busts");
    game.winner = "dealer";
    score -= 1;
  }

  if (game.winner !== "") {
    updateScore();
    $hit.attr("disabled", true);
    $stay.attr("disabled", true);
    gameEnd();
    //clearTable();
  }
}

function gameEnd() {}

function clearTable() {
  $dealer.empty();
  $player.empty();
  console.log("--table cleared--");
}

function hit() {
  console.log("hit");
  drawCard("player");
}

function stay() {
  console.log("stay");
  flipCard();
  if (game.winner === "" && game.dealerTotal < 17) {
    drawCard("dealer");
  } else {
    game.dealerTotal >= game.playerTotal ? (game.winner = "dealer", score -= 1, console.log("dealer's " + game.dealerTotal + " beats player's " + game.playerTotal)) : (game.winner = "player", score += 1, console.log("player's " + game.playerTotal + " beats dealer's " + game.dealerTotal));
  }
}

function flipCard() {}

function updateScore() {
  $score.empty();
  $score.append("<p>Score: " + score + "</p>");
}

function updateCount(card) {
  if (isNaN(Number(card)) || card === "10") {
    game.count -= 1;
  } else if (card < 7) {
    game.count += 1;
  }
  $count.empty();
  $count.append("<p>Count: " + game.count + "</p>");
}

// JSON request function with JSONP proxy
function getJSON(url, cb) {
  var JSONP_PROXY = "https://jsonp.afeld.me/?url=";
  // THIS WILL ADD THE CROSS ORIGIN HEADERS
  var request = new XMLHttpRequest();
  request.open("GET", JSONP_PROXY + url);
  request.onload = function () {
    if (request.status >= 200 && request.status < 400) {
      cb(JSON.parse(request.responseText));
    }
  };
  request.send();
}
//# sourceMappingURL=data:application/json;base64,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Q0FBQztBQUN2QyxTQUFPLENBQUMsTUFBTSxHQUFHLFlBQVc7QUFDMUIsUUFBSSxPQUFPLENBQUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxPQUFPLENBQUMsTUFBTSxHQUFHLEdBQUcsRUFBRTtBQUNqRCxRQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQztLQUN0QztHQUNGLENBQUM7QUFDRixTQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7Q0FDaEIiLCJmaWxlIjoic3JjL21haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgQVBJID0gXCJodHRwOi8vZGVja29mY2FyZHNhcGkuY29tL2FwaS9cIjtcbnZhciBuZXdEZWNrVVJMID0gQVBJICsgXCJzaHVmZmxlLz9kZWNrX2NvdW50PTZcIjtcbnZhciBnYW1lO1xuXG52YXIgY2FyZEJhY2sgPSBcImh0dHA6Ly90aW55dXJsLmNvbS9rcXp6bWJyXCI7XG5cbi8vYnV0dG9uc1xudmFyICRuZXdHYW1lID0gJChcIi5uZXdHYW1lXCIpO1xudmFyICRkZWFsID0gJChcIi5kZWFsXCIpO1xudmFyICRoaXQgPSAkKFwiLmhpdFwiKTtcbnZhciAkc3RheSA9ICQoXCIuc3RheVwiKTtcblxuLy9zY29yZWJvYXJkIGRpdnNcbnZhciAkc2NvcmUgPSAkKFwiLnNjb3JlXCIpO1xudmFyICRjb3VudCA9ICQoXCIuY291bnRcIik7XG5cbi8vY2FyZCBoYW5kIGRpdnNcbnZhciAkZGVhbGVyID0gJChcIi5kZWFsZXJcIik7XG52YXIgJHBsYXllciA9ICQoXCIucGxheWVyXCIpO1xuXG52YXIgc2NvcmUgPSAwO1xuXG4kbmV3R2FtZS5jbGljayhuZXdHYW1lKTtcbiRkZWFsLmNsaWNrKGRlYWwpO1xuJGhpdC5jbGljayhoaXQpO1xuJHN0YXkuY2xpY2soc3RheSk7XG5cbmZ1bmN0aW9uIEdhbWUoKSB7XG4gIHRoaXMuZGVja0lkID0gXCJcIjtcbiAgdGhpcy5oaWRkZW5DYXJkID0gXCJcIjtcbiAgdGhpcy5kZWFsZXJIYW5kID0gW107XG4gIHRoaXMucGxheWVySGFuZCA9IFtdO1xuICB0aGlzLmRlYWxlclRvdGFsID0gMDtcbiAgdGhpcy5wbGF5ZXJUb3RhbCA9IDA7XG4gIHRoaXMud2lubmVyID0gXCJcIjtcbiAgdGhpcy5jb3VudCA9IDA7XG59XG5cbmZ1bmN0aW9uIG5ld0dhbWUoKSB7XG4gIHNjb3JlID0gMDtcbiAgZ2FtZSA9IG5ldyBHYW1lKCk7XG4gIGRlYWwoKTtcbn1cblxuZnVuY3Rpb24gZGVhbCgpIHtcbiAgY2xlYXJUYWJsZSgpO1xuICAkaGl0LmF0dHIoXCJkaXNhYmxlZFwiLCBmYWxzZSk7XG4gICRzdGF5LmF0dHIoXCJkaXNhYmxlZFwiLCBmYWxzZSk7XG5cbiAgaWYgKGdhbWUuZGVja0lkID09PSBcIlwiKSB7XG4gICAgZ2V0SlNPTihuZXdEZWNrVVJMLCBmdW5jdGlvbihkYXRhKSB7XG4gICAgICBnYW1lLmRlY2tJZCA9IGRhdGEuZGVja19pZDtcbiAgICAgIGNvbnNvbGUubG9nKFwiQWJvdXQgdG8gZGVhbCBmcm9tIG5ldyBkZWNrXCIpO1xuICAgICAgZHJhdzQoKTtcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlLmxvZyhcIkFib3V0IHRvIGRlYWwgZnJvbSBjdXJyZW50IGRlY2tcIik7XG4gICAgZHJhdzQoKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBkcmF3NCgpIHtcbiAgZHJhd0NhcmQoXCJkZWFsZXJcIiwgY2FyZEJhY2spO1xuICBkcmF3Q2FyZChcInBsYXllclwiKTtcbiAgZHJhd0NhcmQoXCJkZWFsZXJcIik7XG4gIGRyYXdDYXJkKFwicGxheWVyXCIpO1xufVxuXG5mdW5jdGlvbiBkcmF3Q2FyZChwZXJzb24sIGltYWdlKSB7XG4gIHZhciBjYXJkVVJMID0gQVBJICsgXCJkcmF3L1wiICsgZ2FtZS5kZWNrSWQgKyBcIi8/Y291bnQ9MVwiO1xuICBnZXRKU09OKGNhcmRVUkwsIGZ1bmN0aW9uKGRhdGEsIGNiKSB7XG4gICAgaWYgKGltYWdlKSB7XG4gICAgICB2YXIgaHRtbCA9IFwiPGltZyBjbGFzcz0nY2FyZEltYWdlJyBzcmM9J1wiICsgaW1hZ2UgKyBcIic+XCI7XG4gICAgICAkKFwiLlwiICsgcGVyc29uKS5hcHBlbmQoaHRtbCk7XG4gICAgICBnYW1lLmhpZGRlbkNhcmQgPSBkYXRhLmNhcmRzWzBdLmltYWdlO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgaHRtbCA9IFwiPGltZyBjbGFzcz0nY2FyZEltYWdlJyBzcmM9J1wiICsgZGF0YS5jYXJkc1swXS5pbWFnZSArIFwiJz5cIjtcbiAgICAgICQoXCIuXCIgKyBwZXJzb24pLmFwcGVuZChodG1sKTtcbiAgICB9XG4gICAgaWYgKHBlcnNvbiA9PT0gXCJkZWFsZXJcIikge1xuICAgICAgZ2FtZS5kZWFsZXJIYW5kLnB1c2goZGF0YS5jYXJkc1swXS52YWx1ZSk7XG4gICAgICBjaGVja0RlYWxlclRvdGFsKCk7XG4gICAgICBjb25zb2xlLmxvZyhcImRlYWxlcidzIGhhbmQgLSBcIiArIGdhbWUuZGVhbGVySGFuZCArIFwiICoqKiogZGVhbGVyIGlzIGF0IFwiICsgZ2FtZS5kZWFsZXJUb3RhbCk7XG4gICAgfSBlbHNlIGlmIChwZXJzb24gPT09IFwicGxheWVyXCIpIHtcbiAgICAgIGdhbWUucGxheWVySGFuZC5wdXNoKGRhdGEuY2FyZHNbMF0udmFsdWUpO1xuICAgICAgY2hlY2tQbGF5ZXJUb3RhbCgpO1xuICAgICAgY29uc29sZS5sb2coXCJwbGF5ZXIncyBoYW5kIC0gXCIgKyBnYW1lLnBsYXllckhhbmQgKyBcIiAqKioqIHBsYXllciBpcyBhdCBcIiArIGdhbWUucGxheWVyVG90YWwpO1xuICAgIH1cbiAgICBjaGVja1ZpY3RvcnkoKTtcbiAgICB1cGRhdGVDb3VudChkYXRhLmNhcmRzWzBdLnZhbHVlKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrUGxheWVyVG90YWwoKSB7XG4gIGdhbWUucGxheWVyVG90YWwgPSAwO1xuICBnYW1lLnBsYXllckhhbmQuZm9yRWFjaChmdW5jdGlvbihjYXJkKSB7XG4gICAgaWYgKGNhcmQgPT09IFwiS0lOR1wiIHx8IGNhcmQgPT09IFwiUVVFRU5cIiB8fCBjYXJkID09PSBcIkpBQ0tcIikge1xuICAgICAgZ2FtZS5wbGF5ZXJUb3RhbCArPSAxMDtcbiAgICB9IGVsc2UgaWYgKCFpc05hTihjYXJkKSkge1xuICAgICAgZ2FtZS5wbGF5ZXJUb3RhbCArPSBOdW1iZXIoY2FyZCk7XG4gICAgfVxuICB9KTtcbiAgZ2FtZS5wbGF5ZXJIYW5kLmZvckVhY2goZnVuY3Rpb24oY2FyZCkge1xuICAgIGlmIChjYXJkID09PSBcIkFDRVwiKSB7XG4gICAgICBpZiAoZ2FtZS5wbGF5ZXJUb3RhbCA8PSAxMCkge1xuICAgICAgICBnYW1lLnBsYXllclRvdGFsICs9IDExO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZ2FtZS5wbGF5ZXJUb3RhbCArPSAxO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrRGVhbGVyVG90YWwoKSB7XG4gIGdhbWUuZGVhbGVyVG90YWwgPSAwO1xuICBnYW1lLmRlYWxlckhhbmQuZm9yRWFjaChmdW5jdGlvbihjYXJkKSB7XG4gICAgaWYgKGNhcmQgPT09IFwiS0lOR1wiIHx8IGNhcmQgPT09IFwiUVVFRU5cIiB8fCBjYXJkID09PSBcIkpBQ0tcIikge1xuICAgICAgZ2FtZS5kZWFsZXJUb3RhbCArPSAxMDtcbiAgICB9IGVsc2UgaWYgKCFpc05hTihjYXJkKSkge1xuICAgICAgZ2FtZS5kZWFsZXJUb3RhbCArPSBOdW1iZXIoY2FyZCk7XG4gICAgfVxuICB9KTtcbiAgZ2FtZS5kZWFsZXJIYW5kLmZvckVhY2goZnVuY3Rpb24oY2FyZCkge1xuICAgIGlmIChjYXJkID09PSBcIkFDRVwiKSB7XG4gICAgICBpZiAoZ2FtZS5kZWFsZXJUb3RhbCA8PSAxMCkge1xuICAgICAgICBnYW1lLmRlYWxlclRvdGFsICs9IDExO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZ2FtZS5kZWFsZXJUb3RhbCArPSAxO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGNoZWNrVmljdG9yeSgpIHtcbiAgaWYgKGdhbWUuZGVhbGVyVG90YWwgPT09IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJkZWFsZXIgaGFzIDIxXCIpO1xuICAgIGdhbWUud2lubmVyID0gXCJkZWFsZXJcIjtcbiAgICBzY29yZSAtPSAxO1xuICB9IGVsc2UgaWYgKGdhbWUuZGVhbGVyVG90YWwgPiAyMSkge1xuICAgIGNvbnNvbGUubG9nKFwiZGVhbGVyIGJ1c3RzXCIpO1xuICAgIGdhbWUud2lubmVyID0gXCJwbGF5ZXJcIjtcbiAgICBzY29yZSArPSAxO1xuICB9XG5cbiAgaWYgKGdhbWUucGxheWVyVG90YWwgPT09IDIxKSB7XG4gICAgY29uc29sZS5sb2coXCJwbGF5ZXIgaGFzIDIxXCIpO1xuICAgIGdhbWUud2lubmVyID0gXCJwbGF5ZXJcIjtcbiAgICBzY29yZSArPSAxO1xuICB9IGVsc2UgaWYgKGdhbWUucGxheWVyVG90YWwgPiAyMSkge1xuICAgIGNvbnNvbGUubG9nKFwicGxheWVyIGJ1c3RzXCIpO1xuICAgIGdhbWUud2lubmVyID0gXCJkZWFsZXJcIjtcbiAgICBzY29yZSAtPSAxO1xuICB9XG5cbiAgaWYgKGdhbWUud2lubmVyICE9PSBcIlwiKSB7XG4gICAgdXBkYXRlU2NvcmUoKTtcbiAgICAkaGl0LmF0dHIoXCJkaXNhYmxlZFwiLCB0cnVlKTtcbiAgICAkc3RheS5hdHRyKFwiZGlzYWJsZWRcIiwgdHJ1ZSk7XG4gICAgZ2FtZUVuZCgpO1xuICAgIC8vY2xlYXJUYWJsZSgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGdhbWVFbmQoKSB7XG59XG5cbmZ1bmN0aW9uIGNsZWFyVGFibGUoKSB7XG4gICRkZWFsZXIuZW1wdHkoKTtcbiAgJHBsYXllci5lbXB0eSgpO1xuICBjb25zb2xlLmxvZyhcIi0tdGFibGUgY2xlYXJlZC0tXCIpO1xufVxuXG5mdW5jdGlvbiBoaXQoKSB7XG4gIGNvbnNvbGUubG9nKFwiaGl0XCIpO1xuICBkcmF3Q2FyZChcInBsYXllclwiKTtcbn1cblxuZnVuY3Rpb24gc3RheSgpIHtcbiAgY29uc29sZS5sb2coXCJzdGF5XCIpO1xuICBmbGlwQ2FyZCgpO1xuICBpZiAoZ2FtZS53aW5uZXIgPT09IFwiXCIgJiYgZ2FtZS5kZWFsZXJUb3RhbCA8IDE3KSB7XG4gICAgZHJhd0NhcmQoXCJkZWFsZXJcIik7XG4gIH0gZWxzZSB7XG4gICAgZ2FtZS5kZWFsZXJUb3RhbCA+PSBnYW1lLnBsYXllclRvdGFsID9cbiAgICAgIChnYW1lLndpbm5lciA9IFwiZGVhbGVyXCIsIHNjb3JlIC09IDEsIGNvbnNvbGUubG9nKFwiZGVhbGVyJ3MgXCIgKyBnYW1lLmRlYWxlclRvdGFsICsgXCIgYmVhdHMgcGxheWVyJ3MgXCIgKyBnYW1lLnBsYXllclRvdGFsKSkgOlxuICAgICAgKGdhbWUud2lubmVyID0gXCJwbGF5ZXJcIiwgc2NvcmUgKz0gMSwgY29uc29sZS5sb2coXCJwbGF5ZXIncyBcIiArIGdhbWUucGxheWVyVG90YWwgKyBcIiBiZWF0cyBkZWFsZXIncyBcIiArIGdhbWUuZGVhbGVyVG90YWwpKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBmbGlwQ2FyZCgpIHtcbn1cblxuZnVuY3Rpb24gdXBkYXRlU2NvcmUoKSB7XG4gICRzY29yZS5lbXB0eSgpO1xuICAkc2NvcmUuYXBwZW5kKFwiPHA+U2NvcmU6IFwiICsgc2NvcmUgKyBcIjwvcD5cIik7XG59XG5cbmZ1bmN0aW9uIHVwZGF0ZUNvdW50KGNhcmQpIHtcbiAgaWYgKGlzTmFOKE51bWJlcihjYXJkKSkgfHwgY2FyZCA9PT0gXCIxMFwiKSB7XG4gICAgZ2FtZS5jb3VudCAtPSAxO1xuICB9IGVsc2UgaWYgKGNhcmQgPCA3KSB7XG4gICAgZ2FtZS5jb3VudCArPSAxO1xuICB9XG4gICRjb3VudC5lbXB0eSgpO1xuICAkY291bnQuYXBwZW5kKFwiPHA+Q291bnQ6IFwiICsgZ2FtZS5jb3VudCArIFwiPC9wPlwiKTtcbn1cblxuLy8gSlNPTiByZXF1ZXN0IGZ1bmN0aW9uIHdpdGggSlNPTlAgcHJveHlcbmZ1bmN0aW9uIGdldEpTT04odXJsLCBjYikge1xuICB2YXIgSlNPTlBfUFJPWFkgPSAnaHR0cHM6Ly9qc29ucC5hZmVsZC5tZS8/dXJsPSdcbiAgLy8gVEhJUyBXSUxMIEFERCBUSEUgQ1JPU1MgT1JJR0lOIEhFQURFUlNcbiAgdmFyIHJlcXVlc3QgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgcmVxdWVzdC5vcGVuKCdHRVQnLCBKU09OUF9QUk9YWSArIHVybCk7XG4gIHJlcXVlc3Qub25sb2FkID0gZnVuY3Rpb24oKSB7XG4gICAgaWYgKHJlcXVlc3Quc3RhdHVzID49IDIwMCAmJiByZXF1ZXN0LnN0YXR1cyA8IDQwMCkge1xuICAgICAgY2IoSlNPTi5wYXJzZShyZXF1ZXN0LnJlc3BvbnNlVGV4dCkpO1xuICAgIH1cbiAgfTtcbiAgcmVxdWVzdC5zZW5kKCk7XG59XG4iXX0=